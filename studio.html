<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Webneva Studio ‚Äì AI-driven webbutveckling</title>

  <link rel="icon" href="images/bgk-remove.webneva.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    rel="stylesheet"
  />

  <style>
    :root {
      --w-brand: #0f4c81;
      --w-brand-600: #0c3b63;
      --w-ink-900: #0b1220;
    }
    body { font-family: system-ui,-apple-system,"Segoe UI",Inter,Roboto,"Helvetica Neue",Arial,sans-serif; background: #f5f8fc; color: #0f172a; }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
    .brand { color: var(--w-brand); }
    .brand-bg { background: var(--w-brand); }
    .brand-bg:hover { background: var(--w-brand-600); }

    /* VS Code-lik editor */
    .editor {
      background: #0f172a;
      color: #e2e8f0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    .editor textarea {
      background: transparent;
      color: inherit;
      outline: none;
      border: 0;
      width: 100%;
      height: 480px;
      resize: none;
      padding: 14px;
      caret-color: #93c5fd;
    }
    .editor .tabs button.active {
      color: #93c5fd;
      background: #0b1020;
      border-color: #1f2937;
    }
    .shadow-soft { box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); }

    /* "Browser chrome" runt previewn */
    .browser-chrome {
      background: #0f172a;
      color: #cbd5e1;
      height: 42px;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      display: flex; align-items: center; gap: 10px; padding: 0 14px;
    }
    .traffic-dot { width: 10px; height: 10px; border-radius: 9999px; }
    .traffic-dot.red { background: #ef4444; }
    .traffic-dot.yellow { background: #f59e0b; }
    .traffic-dot.green { background: #22c55e; }
    .browser-url {
      background: #0b1220; color: #9ca3af; border-radius: 10px; padding: 6px 10px; font-size: 12px;
      border: 1px solid #1f2937; min-width: 240px;
    }

    /* Preview device wrapper (skalas) */
    .device-wrap {
      transform-origin: top left;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      overflow: hidden;
      background: white;
    }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f1f5f9; border:1px solid #e2e8f0; padding:2px 6px; border-radius:6px; font-size:12px; }
  </style>
</head>
<body class="antialiased">

  <!-- Header -->
  <header class="fixed inset-x-0 top-0 z-40 bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 lg:px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="images/bgk-remove.webneva.png" alt="Webneva" class="h-9 w-9 object-contain" />
        <div class="leading-tight">
          <div class="text-xl lg:text-2xl font-extrabold brand flex items-center gap-2">
            Webneva <span class="text-slate-800">Studio</span>
            <span class="text-xs rounded bg-emerald-100 text-emerald-700 px-2 py-0.5 align-middle">LIVE</span>
          </div>
          <div class="text-[11px] text-slate-500 -mt-0.5">AI-driven webbutveckling</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="newProject" class="px-3 py-2 rounded-lg border text-sm text-slate-700 hover:bg-white bg-slate-50">
          <i class="fa-solid fa-plus"></i> Nytt projekt
        </button>
        <button id="saveProject" class="px-3 py-2 rounded-lg border text-sm text-slate-700 hover:bg-white bg-slate-50">
          <i class="fa-regular fa-floppy-disk"></i> Spara
        </button>

        <div class="relative">
          <button id="profileBtn" class="px-3 py-2 rounded-lg border text-sm text-slate-700 hover:bg-white bg-slate-50 flex items-center gap-2">
            <i class="fa-solid fa-user"></i> Profil <i class="fa-solid fa-caret-down"></i>
          </button>
          <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 bg-white border rounded-xl shadow-soft py-2">
            <a href="#" class="px-3 py-2 block text-sm hover:bg-slate-50"><i class="fa-regular fa-id-card"></i> Min profil</a>
            <a href="#" class="px-3 py-2 block text-sm hover:bg-slate-50"><i class="fa-solid fa-gear"></i> Inst√§llningar</a>
            <div class="border-t my-1"></div>
            <a href="#" class="px-3 py-2 block text-sm hover:bg-slate-50"><i class="fa-solid fa-arrow-right-to-bracket"></i> Logga in</a>
          </div>
        </div>

        <a href="/" class="px-3 py-2 rounded-lg brand-bg text-white text-sm shadow-soft">
          Startsida
        </a>
      </div>
    </div>
  </header>

  <main class="pt-20 max-w-[1480px] mx-auto px-3 lg:px-6 pb-24 grid grid-cols-1 xl:grid-cols-[44%_56%] gap-5">

    <!-- V√§nster: Editor + AI -->
    <section class="editor rounded-2xl overflow-hidden shadow-soft">
      <div class="flex items-center justify-between px-3 py-2 border-b border-slate-800/60">
        <div class="tabs flex items-center gap-2">
          <!-- Dynamiska flikar -->
          <div id="tabs" class="flex gap-1"></div>
          <button id="addPage" class="ml-2 text-slate-300 hover:text-white text-xs px-2 py-1 border border-slate-700 rounded">
            <i class="fa-solid fa-plus"></i> Ny sida
          </button>
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-400">
          <button id="formatBtn" class="px-2 py-1 border border-slate-700 rounded hover:bg-slate-800">
            <i class="fa-solid fa-broom"></i> Formatera
          </button>
          <span class="hidden md:inline">|</span>
          <span class="hidden md:inline text-slate-500">Tips: tryck <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> f√∂r ‚ÄúUppdatera f√∂rhandsvisning‚Äù.</span>
        </div>
      </div>

      <textarea id="editorArea" spellcheck="false" aria-label="Kod"></textarea>

      <!-- AI-chatt -->
      <div class="border-t border-slate-800/60 p-3">
        <div class="text-slate-200 text-sm mb-1 flex items-center gap-2">
          <i class="fa-solid fa-wand-magic-sparkles text-sky-400"></i> AI-assistent
        </div>
        <div class="text-slate-400 text-xs mb-3">
          Exempel: <span class="italic">‚ÄúSkapa en hemsida f√∂r en thairestaurang med sidorna meny, om oss, kontakt.‚Äù</span>
        </div>
        <div class="flex gap-2">
          <textarea id="aiInput" rows="2" class="flex-1 bg-slate-900/60 border border-slate-700 rounded-lg p-2 text-slate-200 resize-y" placeholder="Skriv en instruktion till AI‚Ä¶"></textarea>
          <button id="aiSend" class="brand-bg px-4 rounded-lg text-white shadow-soft">Skicka</button>
        </div>

        <div id="aiLog" class="mt-3 space-y-2 text-[13px]">
          <div class="text-slate-400">üëã Hej! Beskriv vad du vill bygga s√• genererar jag sidorna √•t dig.</div>
        </div>
      </div>
    </section>

    <!-- H√∂ger: Preview / Device-toolbar -->
    <section class="glass rounded-2xl shadow-soft p-3">
      <!-- Toolbar -->
      <div class="flex flex-wrap items-center gap-2 justify-between mb-2">
        <div class="flex items-center gap-2">
          <label class="text-sm text-slate-600">Enhet:</label>
          <select id="deviceSelect" class="px-2 py-1 rounded border text-sm">
            <option value="1280">Desktop (1280px)</option>
            <option value="1024">Laptop (1024px)</option>
            <option value="820">Tablet (820px)</option>
            <option value="390">Mobil (390px)</option>
          </select>

          <label class="text-sm text-slate-600 ml-3">Skala:</label>
          <select id="scaleSelect" class="px-2 py-1 rounded border text-sm">
            <option value="1">Auto (Fit)</option>
            <option value="0.9">90%</option>
            <option value="0.8">80%</option>
            <option value="0.7">70%</option>
            <option value="0.6">60%</option>
          </select>

          <button id="refreshBtn" class="ml-2 px-3 py-1.5 rounded-lg border text-sm text-slate-700 hover:bg-white bg-slate-50"><i class="fa-solid fa-rotate"></i> Uppdatera</button>
          <button id="explainBtn" class="px-3 py-1.5 rounded-lg border text-sm text-slate-700 hover:bg-white bg-slate-50"><i class="fa-regular fa-lightbulb"></i> F√∂rklara koden</button>
        </div>

        <div class="flex items-center gap-2">
          <span class="text-xs text-slate-500">Sida:</span>
          <select id="pageSelect" class="px-2 py-1 rounded border text-sm"></select>
        </div>
      </div>

      <!-- Browser chrome + Preview -->
      <div class="border rounded-[12px] overflow-hidden bg-white shadow-soft">
        <div class="browser-chrome">
          <span class="traffic-dot red"></span>
          <span class="traffic-dot yellow"></span>
          <span class="traffic-dot green"></span>
          <div class="browser-url flex-1 truncate">
            <span class="text-slate-400">https://</span> webneva-preview
          </div>
          <span class="text-[11px] text-emerald-400">LIVE</span>
        </div>

        <div id="deviceWrap" class="device-wrap">
          <iframe id="preview" title="preview" sandbox="allow-forms allow-modals allow-popups allow-scripts allow-same-origin" class="w-full h-[900px] bg-white"></iframe>
        </div>
      </div>

      <!-- F√∂rklaringar / Historik -->
      <div class="mt-4">
        <div class="text-sm font-semibold mb-1">F√∂rklaringar</div>
        <div id="explanations" class="text-sm text-slate-600 bg-white border rounded-xl p-3">H√§r visas AIs f√∂rklaringar av din kod.</div>
      </div>
    </section>
  </main>

  <script>
    /**********************
     * PROJEKT-STATE
     **********************/
    const DEFAULT_PAGES = {
      "index.html": `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>V√§lkommen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="bg-green-800 text-white py-10">
    <div class="max-w-5xl mx-auto px-6">
      <h1 class="text-4xl font-bold">Rent the Perfect Aircraft</h1>
      <p class="opacity-90 mt-1">From Cessnas to Jets ‚Äì We've got wings for every adventure</p>
      <a href="add-plane.html" class="inline-block mt-5 bg-white text-green-800 px-4 py-2 rounded shadow hover:bg-slate-100">Add Your Plane</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-6 py-10">
    <h2 class="text-xl font-bold text-green-800 mb-4">Available Aircraft</h2>
    <p class="text-slate-600 mb-6">Exempelsida. Byt eller skriv √∂ver med din egen kod.</p>
    <a href="about.html" class="text-green-700 underline">About this site</a>
  </main>

  <footer class="text-center text-xs text-slate-500 py-10">¬© 2025 ‚Äì Demo av Webneva Studio</footer>
</body>
</html>`,
      "about.html": `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>About</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-slate-800">
  <div class="max-w-3xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-3">About This Demo</h1>
    <p class="text-slate-600">Den h√§r sidan visar multi-page routing i preview:en.</p>
    <a href="index.html" class="text-blue-600 underline mt-4 inline-block">Tillbaka</a>
  </div>
</body>
</html>`,
      "add-plane.html": `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Add Plane</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
  <div class="max-w-2xl mx-auto px-6 py-12">
    <h1 class="text-2xl font-bold mb-4">Add your plane</h1>
    <form class="space-y-4">
      <div>
        <label class="block text-sm font-medium">Name</label>
        <input class="mt-1 w-full border rounded px-3 py-2" placeholder="Cessna 172" />
      </div>
      <div>
        <label class="block text-sm font-medium">Hourly rate</label>
        <input type="number" class="mt-1 w-full border rounded px-3 py-2" placeholder="250" />
      </div>
      <button class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800" type="button" onclick="alert('Saved (demo)')">Save</button>
      <a href="index.html" class="ml-3 text-slate-700 underline">Cancel</a>
    </form>
  </div>
</body>
</html>`
    };

    let pages = loadProject() || structuredClone(DEFAULT_PAGES);
    let currentPage = "index.html";
    let currentEditorKey = currentPage;

    const tabsEl = document.getElementById("tabs");
    const editorArea = document.getElementById("editorArea");
    const pageSelect = document.getElementById("pageSelect");
    const preview = document.getElementById("preview");
    const deviceWrap = document.getElementById("deviceWrap");
    const deviceSelect = document.getElementById("deviceSelect");
    const scaleSelect  = document.getElementById("scaleSelect");
    const aiInput = document.getElementById("aiInput");
    const aiLog = document.getElementById("aiLog");
    const explanations = document.getElementById("explanations");

    /**********************
     * UI INIT
     **********************/
    function rebuildTabs() {
      tabsEl.innerHTML = "";
      Object.keys(pages).forEach(k => {
        const b = document.createElement("button");
        b.className = "px-2.5 py-1.5 rounded border border-slate-800 text-slate-300 hover:text-white";
        b.textContent = k;
        if (k === currentEditorKey) b.classList.add("active");
        b.addEventListener("click", ()=> {
          currentEditorKey = k;
          editorArea.value = pages[currentEditorKey] || "";
          rebuildTabs();
        });
        tabsEl.appendChild(b);
      });
    }

    function rebuildPageSelect() {
      pageSelect.innerHTML = "";
      Object.keys(pages).forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k;
        if (k === currentPage) opt.selected = true;
        pageSelect.appendChild(opt);
      });
    }

    function setDeviceAndScale() {
      const width = parseInt(deviceSelect.value, 10);
      const scale = parseFloat(scaleSelect.value);

      // Auto fit proportionellt mot containerbredd
      const containerW = deviceWrap.clientWidth || deviceWrap.getBoundingClientRect().width || 1000;
      let s = scale === 1 ? Math.min(1, containerW / width) : scale;

      deviceWrap.style.width = width + "px";
      deviceWrap.style.transform = `scale(${s})`;
    }

    deviceSelect.addEventListener("change", setDeviceAndScale);
    scaleSelect.addEventListener("change", setDeviceAndScale);
    window.addEventListener("resize", setDeviceAndScale);

    /**********************
     * PREVIEW RENDERING
     **********************/
    function htmlWithBridge(html) {
      // Injicera en router-hook som f√•ngar lokala l√§nkar och skickar postMessage till f√∂r√§ldern
      const bridgeScript = `
<script>
(function(){
  document.addEventListener('click', function(e){
    var a = e.target.closest('a');
    if(!a) return;
    var href = a.getAttribute('href') || '';
    if(!href || href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('#')) return;
    e.preventDefault();
    parent.postMessage({ type: 'webneva:navigate', href: href }, '*');
  }, true);
})();
<\/script>`;
      if (html.includes("</body>")) return html.replace("</body>", bridgeScript + "\n</body>");
      return html + bridgeScript;
    }

    function renderPreview(pageKey) {
      currentPage = pageKey || currentPage;
      rebuildPageSelect();
      const html = pages[currentPage] || "<!doctype html><body>Tom sida</body>";
      preview.srcdoc = htmlWithBridge(html);
    }

    // Navigering fr√•n previewn
    window.addEventListener("message", (ev)=> {
      if (!ev.data || ev.data.type !== "webneva:navigate") return;
      const href = (ev.data.href || "").replace(/^\//,'');
      let target = href;
      if (!pages[target]) {
        // prova med .html om ej finns
        if (!href.endsWith(".html") && pages[href + ".html"]) target = href + ".html";
      }
      if (pages[target]) {
        renderPreview(target);
      } else {
        alert("Sidan finns inte i projektet: " + href);
      }
    });

    /**********************
     * EDITOR BINDING
     **********************/
    editorArea.value = pages[currentEditorKey] || "";
    let saveTimer = null;

    editorArea.addEventListener("input", ()=> {
      pages[currentEditorKey] = editorArea.value;
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(()=> {
        saveProject();
        renderPreview(currentPage);
      }, 500);
    });

    // Ctrl+Enter = uppdatera preview
    editorArea.addEventListener("keydown", (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        renderPreview(currentPage);
      }
    });

    document.getElementById("refreshBtn").addEventListener("click", ()=> renderPreview(currentPage));

    pageSelect.addEventListener("change", ()=> {
      renderPreview(pageSelect.value);
    });

    document.getElementById("formatBtn").addEventListener("click", ()=>{
      // Minimal ‚Äúformatter‚Äù: trimmar & normaliserar radbrytningar
      editorArea.value = editorArea.value.replace(/\r\n/g,"\n").trim()+"\n";
      pages[currentEditorKey] = editorArea.value;
      saveProject();
      renderPreview(currentPage);
    });

    document.getElementById("addPage").addEventListener("click", ()=>{
      const name = prompt("Namn p√• ny sida (t.ex. kontakt.html):");
      if (!name) return;
      if (pages[name]) return alert("Finns redan.");
      pages[name] = "<!doctype html><html><head><meta charset='utf-8'><title>"+name+"</title><meta name='viewport' content='width=device-width, initial-scale=1'/><script src='https://cdn.tailwindcss.com'><\/script></head><body class='p-6'><h1 class='text-2xl font-bold'>"+name+"</h1><p>Ny sida.</p><a href='index.html' class='text-blue-600 underline mt-4 inline-block'>Tillbaka</a></body></html>";
      currentEditorKey = name;
      rebuildTabs();
      rebuildPageSelect();
      editorArea.value = pages[name];
      renderPreview(name);
      saveProject();
    });

    /**********************
     * AI-KOPPLING
     **********************/
    function logAI(msg, kind="sys") {
      const row = document.createElement("div");
      row.className = kind === "err" ? "text-red-400" : (kind === "ok" ? "text-emerald-300" : "text-slate-400");
      row.textContent = msg;
      aiLog.appendChild(row);
      aiLog.scrollTop = aiLog.scrollHeight;
    }

    function extractJsonBlock(text) {
      // F√∂rs√∂k hitta ett ```json ... ``` block ‚Äì annars testa r√• JSON
      const fence = text.match(/```json\\s*([\\s\\S]*?)```/i);
      const raw = fence ? fence[1] : text;
      try { return JSON.parse(raw); } catch { return null; }
    }

    // Systemprompt ‚Äì instruerar AI att svara i JSON
    const SYSTEM_PROMPT = `
Du √§r en hj√§lpsam assistent som genererar eller f√∂rb√§ttrar en multi-page webb. Svara ALLTID som JSON i formatet:
{
  "pages": { "filnamn.html": "<!doctype html>...full HTML...", "...": "..." },
  "message": "kort status",
  "explanations": "valfritt: f√∂rklaring / checklistor / vad som √§ndrades"
}
√Ñndra/addera bara sidor som ber√∂rs. HTML ska vara komplett per sida (doctype/head/body).
Om anv√§ndaren ber att ‚Äú√§ndra knappen till r√∂d‚Äù ‚Äì √§ndra relevant sida och returnera den sidan under "pages".
`;

    async function callAI(userMessage) {
      const payload = {
        message:
`SYSTEM:
${SYSTEM_PROMPT}

NUVARANDE SIDOR (JSON):
${JSON.stringify({ pages }, null, 2)}

ANV√ÑNDARE:
${userMessage}

SVARA ENDAST SOM JSON ENLIGT FORMATET OVAN.`
      };

      try {
        logAI("‚è≥ Skickar till AI‚Ä¶");
        const res = await fetch("/api/openai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error("API-svar "+res.status+": "+t);
        }

        const data = await res.json();
        // F√∂rv√§ntar reply med text (kan inneh√•lla jsonblock)
        const json = extractJsonBlock(data.reply || "");
        if (!json || !json.pages) {
          logAI("‚ö†Ô∏è AI svarade inte i r√§tt format. Visar r√•-svar i f√∂rklaringar.", "err");
          explanations.textContent = (data.reply || "").slice(0, 4000);
          return;
        }

        // Applicera √§ndringar
        const changed = Object.keys(json.pages);
        changed.forEach(k => { pages[k] = json.pages[k]; });
        saveProject();

        // Om AI har skapat nya sidor ‚Äì bygg flikar & lista
        rebuildTabs();
        rebuildPageSelect();

        // Om AI pekar p√• startsidan i text ‚Äì f√∂rs√∂k v√§lja
        if (pages["index.html"]) {
          renderPreview("index.html");
        } else {
          // annars rendera nuvarande
          renderPreview(currentPage);
        }

        logAI("‚úÖ AI uppdaterade: "+ changed.join(", "), "ok");
        if (json.message) logAI("üí¨ "+json.message);
        if (json.explanations) explanations.textContent = json.explanations;

        // S√§tt editor p√• f√∂rsta √§ndrade sida f√∂r tydlighet
        if (changed[0]) {
          currentEditorKey = changed[0];
          editorArea.value = pages[currentEditorKey];
          rebuildTabs();
        }

      } catch (err) {
        console.error(err);
        logAI("‚ùå Fel: "+err.message, "err");
        alert("Ett fel uppstod vid AI-anropet. Se loggen.");
      }
    }

    document.getElementById("aiSend").addEventListener("click", ()=>{
      const msg = aiInput.value.trim();
      if (!msg) return;
      aiInput.value = "";
      logAI("üßë‚Äçüíª Du: "+msg, "ok");
      callAI(msg);
    });

    // ‚ÄúF√∂rklara koden‚Äù ‚Äì skickar sammanfattningsprompt
    document.getElementById("explainBtn").addEventListener("click", ()=>{
      callAI("F√∂rklara kort vad denna kodbas g√∂r och ge 5 f√∂rb√§ttringsf√∂rslag.");
    });

    /**********************
     * MENYER / SPARA / PROFIL
     **********************/
    document.getElementById("newProject").addEventListener("click", ()=>{
      if (!confirm("Starta nytt projekt? Dina osparade √§ndringar f√∂rsvinner.")) return;
      pages = structuredClone(DEFAULT_PAGES);
      currentPage = "index.html";
      currentEditorKey = "index.html";
      editorArea.value = pages[currentEditorKey];
      rebuildTabs(); rebuildPageSelect();
      renderPreview(currentPage);
      saveProject();
      aiLog.innerHTML = "";
      logAI("‚ú® Nytt projekt startat.");
    });

    document.getElementById("saveProject").addEventListener("click", ()=>{
      saveProject();
      logAI("üíæ Sparat lokalt.");
    });

    const profileBtn = document.getElementById("profileBtn");
    const profileMenu = document.getElementById("profileMenu");
    profileBtn.addEventListener("click", ()=>{
      profileMenu.classList.toggle("hidden");
    });
    document.addEventListener("click",(e)=>{
      if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
        profileMenu.classList.add("hidden");
      }
    });

    /**********************
     * PERSISTENS
     **********************/
    function saveProject() {
      try {
        localStorage.setItem("webneva:project", JSON.stringify(pages));
      } catch {}
    }
    function loadProject() {
      try {
        const raw = localStorage.getItem("webneva:project");
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    /**********************
     * STARTUP
     **********************/
    rebuildTabs();
    rebuildPageSelect();
    renderPreview(currentPage);
    setDeviceAndScale();
  </script>
</body>
</html>
