<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Webneva Studio ‚Äì AI-driven webbutveckling</title>
  <link rel="icon" href="images/bgk-remove.webneva.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (localStorage.getItem('wn-theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }
  </script>
  <style>
    .brand { color:#0f4c81 }
    .btn-brand{background:#0f4c81}
    .btn-brand:hover{background:#0c3b63}
    .glass{background:rgba(255,255,255,.85);backdrop-filter:saturate(120%) blur(10px)}
    .codearea{tab-size:2}
    .tabs button[aria-current="true"]{background:#0f4c81;color:#fff}
    .profile-menu{display:none}
    .profile.open .profile-menu{display:block}
    .device-frame{border-radius:14px;border:1px solid rgba(15,25,45,.1);box-shadow:0 15px 35px rgba(0,0,0,.08)}
  </style>
</head>
<body class="antialiased text-slate-900 dark:bg-slate-950 dark:text-slate-100">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/85 dark:bg-slate-900/85 backdrop-blur border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-5 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="images/bgk-remove.webneva.png" class="h-8 w-8 object-contain" alt="Webneva">
        <div class="font-extrabold text-xl brand">Webneva <span class="text-sky-500">Studio</span> <span class="text-xs align-super bg-green-100 text-green-700 px-1.5 py-0.5 rounded">LIVE</span></div>
      </div>

      <div class="flex items-center gap-2">
        <button id="newBtn" class="px-3 py-2 text-sm rounded border border-slate-200 dark:border-slate-700 hover:bg-white/70 dark:hover:bg-slate-800/60">Nytt projekt</button>
        <button id="saveBtn" class="px-3 py-2 text-sm rounded border border-slate-200 dark:border-slate-700 hover:bg-white/70 dark:hover:bg-slate-800/60">Spara</button>
        <a href="/" class="btn-brand text-white px-3 py-2 rounded text-sm">Start¬≠sida</a>

        <!-- Profil dropdown -->
        <div id="profile" class="relative profile">
          <button class="ml-2 flex items-center gap-2 px-3 py-2 rounded border border-slate-200 dark:border-slate-700 hover:bg-white/60 dark:hover:bg-slate-800/60">
            <img src="images/bgk-remove.webneva.png" class="h-5 w-5 rounded" alt="">
            <span class="text-sm">Profil</span>
            <svg class="h-3.5 w-3.5 opacity-60" viewBox="0 0 10 6" fill="currentColor"><path d="M1 1l4 4 4-4"/></svg>
          </button>
          <div class="profile-menu absolute right-0 mt-2 w-60 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-lg">
            <div class="px-4 py-3 text-sm">
              <div class="font-semibold">Inloggad som</div>
              <div class="text-slate-500">g√§st@webneva.se</div>
            </div>
            <div class="border-t border-slate-200 dark:border-slate-800"></div>
            <button id="themeToggle" class="w-full text-left px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-800 text-sm">Tema: Ljust / M√∂rkt</button>
            <button class="w-full text-left px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-800 text-sm" disabled>Inst√§llningar (kommande)</button>
            <button class="w-full text-left px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-800 text-sm" disabled>Logga ut (kommande)</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-5 py-5 grid grid-cols-12 gap-5">

    <!-- V√§nster: Editor + AI -->
    <section class="col-span-12 lg:col-span-5 flex flex-col gap-4">

      <!-- Flikar (sidor) -->
      <div class="glass dark:bg-slate-900/70 rounded-xl p-3 shadow border border-slate-200 dark:border-slate-800">
        <div id="tabs" class="tabs flex flex-wrap gap-2">
          <button data-page="index.html" class="px-3 py-1.5 rounded border border-slate-200 dark:border-slate-700" aria-current="true">Start</button>
          <button data-page="about.html" class="px-3 py-1.5 rounded border border-slate-200 dark:border-slate-700">Om</button>
          <button data-page="add-plane.html" class="px-3 py-1.5 rounded border border-slate-200 dark:border-slate-700">L√§gg till</button>
          <button id="addTab" class="ml-auto px-3 py-1.5 rounded border border-slate-200 dark:border-slate-700">+ Ny sida</button>
        </div>
        <!-- Code editor -->
        <textarea id="editor" class="codearea mt-3 h-[48vh] w-full font-mono text-[13px] leading-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-sky-400" spellcheck="false"></textarea>
        <div class="mt-2 flex items-center gap-2">
          <button id="formatBtn" class="px-3 py-2 text-sm rounded border border-slate-200 dark:border-slate-700 hover:bg-white/60 dark:hover:bg-slate-800/60">Formattera</button>
          <button id="updateBtn" class="btn-brand text-white px-4 py-2 rounded text-sm shadow">Uppdatera</button>
          <button id="explainBtn" class="px-3 py-2 text-sm rounded border border-slate-200 dark:border-slate-700 hover:bg-white/60 dark:hover:bg-slate-800/60">F√∂rklara koden</button>
        </div>
      </div>

      <!-- AI Assistent -->
      <div class="glass dark:bg-slate-900/70 rounded-xl p-3 shadow border border-slate-200 dark:border-slate-800">
        <div class="font-semibold mb-2">ü§ñ AI-assistent</div>
        <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Exempel: ‚ÄùSkapa en hemsida f√∂r en restaurang med sidorna meny, om oss, kontakt.‚Äù</p>
        <div class="flex gap-2">
          <input id="aiInput" class="flex-1 px-3 py-2 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900" placeholder="Beskriv vad du vill bygga...">
          <button id="aiGenerate" class="btn-brand px-4 py-2 rounded text-white">Generera</button>
        </div>
        <div id="aiExplain" class="mt-3 text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap hidden"></div>
      </div>

    </section>

    <!-- H√∂ger: Preview stor -->
    <section class="col-span-12 lg:col-span-7">
      <div class="glass dark:bg-slate-900/70 rounded-xl p-3 shadow border border-slate-200 dark:border-slate-800">
        <div class="flex items-center justify-between px-3 py-2">
          <div class="text-sm font-semibold opacity-70">F√∂rhandsvisning</div>
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center gap-1 text-xs text-green-700 bg-green-100 px-2 py-0.5 rounded"><span class="h-2 w-2 rounded-full bg-green-600"></span>LIVe</span>
          </div>
        </div>

        <!-- L√•tsas-datorram, stor -->
        <div class="device-frame overflow-hidden bg-slate-900/90">
          <div class="bg-slate-800 text-slate-100 text-xs px-4 py-2 flex items-center gap-2">
            <span class="inline-block h-2 w-2 rounded-full bg-red-400"></span>
            <span class="inline-block h-2 w-2 rounded-full bg-amber-400"></span>
            <span class="inline-block h-2 w-2 rounded-full bg-green-400"></span>
            <span class="ml-3 opacity-70">webneva-preview</span>
          </div>
          <iframe id="preview" class="w-full h-[68vh] bg-white dark:bg-slate-900" sandbox="allow-scripts allow-same-origin" referrerpolicy="no-referrer"></iframe>
        </div>
      </div>

      <!-- F√∂rklaringar / logg -->
      <div class="mt-4 glass dark:bg-slate-900/70 rounded-xl p-3 shadow border border-slate-200 dark:border-slate-800">
        <div class="text-sm font-semibold mb-2">F√∂rklaringar</div>
        <div id="explanations" class="text-sm text-slate-700 dark:text-slate-300">H√§r visas AI:s f√∂rklaringar av din kod.</div>
      </div>
    </section>

  </main>

  <script>
    // --- Profilmeny / Tema ---
    const profile = document.getElementById('profile');
    profile.addEventListener('click', (e) => {
      profile.classList.toggle('open');
      e.stopPropagation();
    });
    document.addEventListener('click', () => profile.classList.remove('open'));
    document.getElementById('themeToggle').addEventListener('click', () => {
      const root = document.documentElement;
      const isDark = root.classList.toggle('dark');
      localStorage.setItem('wn-theme', isDark ? 'dark' : 'light');
    });

    // --- Sidor / Projekt-minne ---
    const DEFAULT_PAGES = {
      "index.html": `<!DOCTYPE html>
<html lang="sv"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rent the Perfect Aircraft</title>
<script src="https://cdn.tailwindcss.com"></script>
</head><body class="bg-slate-50">
<header class="bg-green-800 text-white py-10">
  <div class="max-w-5xl mx-auto px-4">
    <h1 class="text-3xl md:text-4xl font-extrabold">Rent the Perfect Aircraft</h1>
    <p class="opacity-90 mt-2">From Cessnas to Jets ‚Äì We've got wings for every adventure</p>
    <div class="mt-5"><a href="add-plane.html" class="bg-white text-green-900 px-4 py-2 rounded shadow hover:bg-slate-100">Add Your Plane</a></div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-10">
  <h2 class="text-xl font-semibold text-green-900">Available Aircraft</h2>
  <p class="text-slate-600">Exempelsida. Byt eller skriv √∂ver med din egen kod.</p>
  <div class="mt-4"><a class="text-sky-700 underline" href="about.html">About this site</a></div>
  <section class="grid md:grid-cols-3 gap-5 mt-8">
    <article class="bg-white rounded-xl shadow border overflow-hidden">
      <img src="https://images.unsplash.com/photo-1600442712340-39c41fdab67b?q=80&w=1200&auto=format&fit=crop" class="h-40 w-full object-cover" alt="">
      <div class="p-4">
        <h3 class="font-semibold">Cessna 172 Skyhawk</h3>
        <p class="text-sm text-slate-600">Perfect for training. 4 seats.</p>
        <div class="flex items-center justify-between mt-3">
          <span class="font-bold">$200/hr</span>
          <button class="bg-green-700 text-white px-3 py-1 rounded">Book Now</button>
        </div>
      </div>
    </article>
    <article class="bg-white rounded-xl shadow border overflow-hidden">
      <img src="https://images.unsplash.com/photo-1512428559087-560fa5ceab42?q=80&w=1200&auto=format&fit=crop" class="h-40 w-full object-cover" alt="">
      <div class="p-4">
        <h3 class="font-semibold">Piper PA-28 Cherokee</h3>
        <p class="text-sm text-slate-600">Comfort meets agility.</p>
        <div class="flex items-center justify-between mt-3">
          <span class="font-bold">$250/hr</span>
          <button class="bg-green-700 text-white px-3 py-1 rounded">Book Now</button>
        </div>
      </div>
    </article>
    <article class="bg-white rounded-xl shadow border overflow-hidden">
      <img src="https://images.unsplash.com/photo-1457305237443-44c3d5a30b89?q=80&w=1200&auto=format&fit=crop" class="h-40 w-full object-cover" alt="">
      <div class="p-4">
        <h3 class="font-semibold">Beechcraft Baron 58</h3>
        <p class="text-sm text-slate-600">Twin-engine luxury. 6 seats.</p>
        <div class="flex items-center justify-between mt-3">
          <span class="font-bold">$450/hr</span>
          <button class="bg-green-700 text-white px-3 py-1 rounded">Book Now</button>
        </div>
      </div>
    </article>
  </section>
</main>

<footer class="text-center text-xs text-slate-500 py-10">¬© 2025 ‚Äì Demo av Webneva Studio</footer>
</body></html>`,

      "about.html": `<!DOCTYPE html>
<html lang="sv"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>About this demo</title>
<script src="https://cdn.tailwindcss.com"></script>
</head><body class="bg-slate-50">
<main class="max-w-3xl mx-auto px-4 py-12">
  <h1 class="text-3xl font-extrabold">About This Demo</h1>
  <p class="mt-2 text-slate-600">Den h√§r sidan visar multi-page routing i f√∂rhandsvisningen.</p>
  <div class="mt-5"><a class="text-sky-700 underline" href="index.html">Tillbaka</a></div>
</main>
</body></html>`,

      "add-plane.html": `<!DOCTYPE html>
<html lang="sv"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Add your plane</title>
<script src="https://cdn.tailwindcss.com"></script>
</head><body class="bg-slate-50">
<main class="max-w-3xl mx-auto px-4 py-12">
  <h1 class="text-2xl font-semibold">Add your plane</h1>
  <form class="mt-5 space-y-3">
    <div>
      <label class="block text-sm mb-1">Name</label>
      <input class="w-full border rounded px-3 py-2" placeholder="Cessna 172">
    </div>
    <div>
      <label class="block text-sm mb-1">Hourly rate</label>
      <input class="w-full border rounded px-3 py-2" placeholder="250">
    </div>
    <div class="flex gap-2">
      <button class="bg-green-700 text-white px-3 py-2 rounded">Save</button>
      <a class="px-3 py-2 rounded border" href="index.html">Cancel</a>
    </div>
  </form>
</main>
</body></html>`
    };

    let pages = JSON.parse(localStorage.getItem('wn-pages') || 'null') || structuredClone(DEFAULT_PAGES);
    const tabsEl = document.getElementById('tabs');
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const explanations = document.getElementById('explanations');
    const aiExplainBox = document.getElementById('aiExplain');

    let currentPage = 'index.html';

    function setActiveTab(name){
      currentPage = name;
      tabsEl.querySelectorAll('button[data-page]').forEach(b=>{
        b.setAttribute('aria-current', b.dataset.page===name ? 'true' : 'false');
      });
      editor.value = pages[currentPage] || '';
      renderPreview();
      persist();
    }

    function persist(){
      localStorage.setItem('wn-pages', JSON.stringify(pages));
    }

    function buildPreviewHTML(){
      // Router: intercepta l√§nkar i preview och ladda r√§tt sida ur "pages".
      const routerScript = `
        <script>
          (function(){
            document.addEventListener('click', function(e){
              const a = e.target.closest('a[href]');
              if(!a) return;
              const href = a.getAttribute('href');
              if(!href) return;
              if(href.endsWith('.html')){
                e.preventDefault();
                parent.postMessage({type:'NAVIGATE', page: href}, '*');
              }
            }, true);
          })();
        <\\/script>`;
      // Injicera script i slutet (om m√∂jligt)
      let html = pages[currentPage] || '';
      if (html.includes('</body>')) {
        html = html.replace('</body>', routerScript + '</body>');
      } else {
        html += routerScript;
      }
      return html;
    }

    function renderPreview(){
      preview.srcdoc = buildPreviewHTML();
    }

    window.addEventListener('message', (e) => {
      if (!e.data) return;
      if (e.data.type === 'NAVIGATE') {
        const p = e.data.page;
        if (pages[p]) {
          setActiveTab(p);
        }
      }
    });

    // Init flikar
    tabsEl.querySelectorAll('button[data-page]').forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveTab(btn.dataset.page));
    });
    document.getElementById('addTab').addEventListener('click', ()=>{
      const base = prompt('Filnamn (t.ex. kontakt.html):');
      if(!base || !base.endsWith('.html')) return alert('Ange ett giltigt filnamn som slutar p√• .html');
      pages[base] = `<!DOCTYPE html><html lang="sv"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${base}</title><script src="https://cdn.tailwindcss.com"><\/script></head><body class="p-6"><h1 class="text-2xl font-bold">${base}</h1><p>Ny sida.</p><p><a class="text-sky-700 underline" href="index.html">Tillbaka</a></p></body></html>`;
      // skapa knapp
      const b = document.createElement('button');
      b.dataset.page = base;
      b.className = 'px-3 py-1.5 rounded border border-slate-200 dark:border-slate-700';
      b.textContent = base.replace('.html','');
      b.addEventListener('click', ()=> setActiveTab(base));
      tabsEl.insertBefore(b, document.getElementById('addTab'));
      setActiveTab(base);
      persist();
    });

    // Editor events
    editor.addEventListener('input', ()=>{
      pages[currentPage] = editor.value;
      renderPreview();
      persist();
    });
    document.getElementById('updateBtn').addEventListener('click', renderPreview);
    document.getElementById('formatBtn').addEventListener('click', ()=>{
      // superenkel formattering: trim & newline
      pages[currentPage] = editor.value = editor.value.trim() + '\n';
      renderPreview();
      persist();
    });

    // F√∂rklara koden via AI
    document.getElementById('explainBtn').addEventListener('click', async ()=>{
      aiExplainBox.classList.remove('hidden');
      aiExplainBox.textContent = '‚è≥ AI analyserar din kod...';
      try{
        const res = await fetch('/api/openai', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: `F√∂rklara denna kod kortfattat och punktvis f√∂r en utvecklare:\n\n${pages[currentPage]}` })
        });
        const data = await res.json();
        aiExplainBox.textContent = data.reply || 'Ingen f√∂rklaring.';
        explanations.textContent = data.reply || 'Ingen f√∂rklaring.';
      }catch(e){
        aiExplainBox.textContent = 'Fel vid anrop till AI.';
      }
    });

    // Generera sidor via AI
    document.getElementById('aiGenerate').addEventListener('click', async ()=>{
      const prompt = document.getElementById('aiInput').value.trim();
      if(!prompt) return alert('Skriv vad du vill skapa.');
      aiExplainBox.classList.remove('hidden');
      aiExplainBox.textContent = '‚è≥ Skapar f√∂rslag...';

      try{
        const res = await fetch('/api/openai', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: `Generera ett komplett flersidigt webbprojekt i ren HTML (utan <script src> f√∂rutom Tailwind via CDN) med minst 3 sidor. Sidorna ska l√§nka till varandra med <a href="...html">. Beskrivning: ${prompt}. Returnera endast HTML f√∂r startsidan i ett enda kodblock (m√§rk inte upp med spr√•k), och n√§mn namnen p√• de andra sidorna i en punktlista sist.` })
        });
        const data = await res.json();
        const reply = (data && data.reply) ? data.reply : '';

        // F√∂rs√∂k extrahera HTML-kodblock
        const match = reply.match(/```(?:html)?\s*([\s\S]*?)```/i);
        const html = match ? match[1] : reply;

        pages['index.html'] = html.trim();
        // Skapa tv√• tomma sidor om AI n√§mnt dem i slutet (heuristik)
        if(!pages['about.html']) pages['about.html'] = DEFAULT_PAGES['about.html'];
        if(!pages['add-plane.html']) pages['add-plane.html'] = DEFAULT_PAGES['add-plane.html'];

        // Uppdatera editor + preview
        setActiveTab('index.html');
        aiExplainBox.textContent = 'Klart! Startsidan √§r genererad. Du kan nu be mig justera f√§rger, knappar osv.';
        persist();

      }catch(e){
        aiExplainBox.textContent = 'Fel vid anrop till AI.';
      }
    });

    // Nytt/Spara (lokalt)
    document.getElementById('newBtn').addEventListener('click', ()=>{
      if(!confirm('Skapa nytt tomt projekt? Dina lokala √§ndringar f√∂rsvinner.')) return;
      pages = structuredClone(DEFAULT_PAGES);
      // d√∂da extra tabs
      tabsEl.querySelectorAll('button[data-page]').forEach(b=>b.remove());
      ['index.html','about.html','add-plane.html'].forEach((p,i)=>{
        const b = document.createElement('button');
        b.dataset.page = p;
        b.textContent = p==='index.html'?'Start':p.replace('.html','');
        b.className = 'px-3 py-1.5 rounded border border-slate-200 dark:border-slate-700';
        if(i===0) b.setAttribute('aria-current','true');
        b.addEventListener('click', ()=> setActiveTab(p));
        tabsEl.insertBefore(b, document.getElementById('addTab'));
      });
      setActiveTab('index.html');
      persist();
    });
    document.getElementById('saveBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(pages,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'webneva-project.json';
      a.click(); URL.revokeObjectURL(url);
    });

    // Start
    // skapa ev nya tab-knappar f√∂r extra sidor
    const known = new Set(['index.html','about.html','add-plane.html']);
    Object.keys(pages).forEach(p=>{
      if(!known.has(p)) {
        const b = document.createElement('button');
        b.dataset.page = p;
        b.textContent = p.replace('.html','');
        b.className = 'px-3 py-1.5 rounded border border-slate-200 dark:border-slate-700';
        b.addEventListener('click', ()=> setActiveTab(p));
        tabsEl.insertBefore(b, document.getElementById('addTab'));
      }
    });
    setActiveTab('index.html');
  </script>
</body>
</html>
