<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webneva Studio – AI-driven webbutveckling</title>
  <link rel="icon" href="images/bgk-remove.webneva.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/6f4c1b8d3b.js" crossorigin="anonymous"></script>
  <style>
    /* HuggingFace-liknande mörk/glas look */
    :root{
      --bg: #0c1021;
      --panel:#121730cc;
      --stroke:#2a2f45;
      --brand:#7c4dff;   /* lila accent */
      --brand-2:#00e0ff; /* cyan accent */
      --text:#cfd5ff;
      --muted:#97a0c3;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
    }
    html,body{height:100%}
    body{
      background:
        radial-gradient(1200px 600px at 10% -20%, rgba(0,224,255,.15), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(124,77,255,.18), transparent 70%),
        var(--bg);
      color: var(--text);
      font-synthesis-weight: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .glass{background:var(--panel); backdrop-filter: blur(16px); border:1px solid var(--stroke)}
    .btn{display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--stroke); padding:.55rem .9rem; border-radius:.7rem}
    .btn:hover{border-color:#3b4262}
    .btn-brand{background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:white; border:0}
    .btn-soft{background:#1a1f36; color:var(--text)}
    .btn-ghost{background:transparent; color:var(--text)}
    .chip{border:1px solid var(--stroke); border-radius:999px; padding:.25rem .6rem; font-size:.75rem; color:var(--muted)}
    .dragbar{width:8px; cursor:col-resize; background:linear-gradient(180deg,#ffffff08,#ffffff06); border-left:1px solid #00000040; border-right:1px solid #ffffff14}
    .input, textarea{
      background:#0e1428; border:1px solid var(--stroke); color:var(--text);
      border-radius:.7rem; outline:none; transition:.2s;
    }
    .input:focus, textarea:focus{border-color:#38406a; box-shadow:0 0 0 3px #7c4dff22}
    .kbd{border:1px solid var(--stroke); border-radius:.4rem; padding:.1rem .35rem; background:#141a33; font-size:.75rem; color:var(--muted)}
    .scroll-slim{scrollbar-width:thin; scrollbar-color:#445 lighttransparent}
  </style>
</head>
<body class="min-h-full">

  <!-- Topbar -->
  <header class="sticky top-0 z-50 border-b border-[var(--stroke)] glass">
    <div class="max-w-[1600px] mx-auto px-5 py-3 flex items-center gap-3">
      <img src="images/bgk-remove.webneva.png" class="h-[28px] w-[28px] rounded-md" alt="Webneva">
      <div class="flex items-baseline gap-2">
        <h1 class="text-lg font-bold tracking-tight">Webneva <span class="opacity-70">Studio</span></h1>
        <span class="chip">LIVE</span>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button id="newProject" class="btn btn-ghost"><i class="fa-regular fa-file"></i> Nytt projekt</button>
        <button id="saveProject" class="btn btn-ghost"><i class="fa-regular fa-folder-down"></i> Exportera</button>

        <div class="relative">
          <button id="profileBtn" class="btn btn-soft"><i class="fa-regular fa-user"></i> Profil <i class="fa-solid fa-chevron-down text-xs opacity-70"></i></button>
          <div id="profileMenu" class="absolute right-0 mt-2 w-56 p-2 glass hidden rounded-xl">
            <div class="px-3 py-2 text-sm text-[var(--muted)]">Inställningar</div>
            <button class="btn w-full btn-ghost justify-start"><i class="fa-regular fa-gear"></i> Allmänt</button>
            <button class="btn w-full btn-ghost justify-start"><i class="fa-regular fa-shield"></i> Säkerhet</button>
            <button class="btn w-full btn-ghost justify-start"><i class="fa-regular fa-right-from-bracket"></i> Logga ut</button>
          </div>
        </div>

        <a href="/" class="btn btn-brand"><i class="fa-regular fa-house"></i> Startsida</a>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <main class="max-w-[1600px] mx-auto px-4 pt-6 pb-12">
    <div class="flex gap-2 h-[calc(100vh-120px)]">

      <!-- LEFT: editor + AI -->
      <section id="leftCol" class="w-[38%] min-w-[340px] flex flex-col gap-3">
        <!-- Tabs (pages) -->
        <div class="glass rounded-xl p-3">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-[var(--muted)]">Sidor</span>
            <button id="addTab" class="btn btn-soft text-sm"><i class="fa-regular fa-plus"></i> Ny sida</button>
          </div>
          <div id="tabs" class="flex gap-2 flex-wrap"></div>
        </div>

        <!-- Editor -->
        <div class="glass rounded-xl p-3 flex-1 flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-[var(--muted)]">HTML / CSS / JS</span>
            <div class="flex gap-2">
              <button id="formatBtn" class="btn btn-ghost text-sm"><i class="fa-regular fa-wand-magic-sparkles"></i> Formatera</button>
              <button id="updatePreview" class="btn btn-ghost text-sm"><i class="fa-regular fa-rotate"></i> Uppdatera</button>
            </div>
          </div>
          <textarea id="editor"
            class="flex-1 resize-none p-3 text-sm leading-6 scroll-slim"
            placeholder="Din HTML här..."></textarea>
        </div>

        <!-- AI assistant -->
        <div class="glass rounded-xl p-3">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-[var(--muted)]">AI-assistent</span>
            <span class="text-xs text-[var(--muted)]">Tips: Beskriv vad du vill bygga, så skapar AI hela sidan automatiskt.</span>
          </div>
          <div class="flex gap-2 mb-2">
            <input id="aiPrompt" class="input px-3 py-2 w-full" placeholder="Ex: Skapa en restaurang-sida. Mål: Få bokningar. Färgtema: Röd & svart. Sidor: Start, boka bord, kontakt.">
            <button id="generateSite" class="btn btn-brand"><i class="fa-regular fa-sparkles"></i> Generera</button>
          </div>
          <div class="flex gap-2">
            <button id="improveBtn" class="btn btn-soft"><i class="fa-regular fa-wand-magic-sparkles"></i> Förbättra</button>
            <button id="applyImprove" class="btn btn-soft"><i class="fa-regular fa-bolt"></i> Applicera instruktion</button>
            <button id="explainBtn" class="btn btn-ghost"><i class="fa-regular fa-circle-question"></i> Förklara koden</button>
          </div>

          <!-- AI explanations -->
          <details id="expBox" class="mt-3 open:">
            <summary id="expToggle" class="cursor-pointer text-sm text-[var(--muted)] flex items-center gap-2">
              <i id="expIcon" class="fa-solid fa-chevron-right text-xs"></i> AI-förklaringar
            </summary>
            <div id="expBody" class="hidden mt-2 rounded-lg bg-[#0b1130] border border-[var(--stroke)] p-3 text-sm text-[var(--muted)] whitespace-pre-wrap"></div>
          </details>
        </div>
      </section>

      <!-- Draggable divider (optional desktop) -->
      <div class="hidden md:block dragbar rounded-lg" id="dragbar" title="Dra för att justera storlek"></div>

      <!-- RIGHT: Preview -->
      <section id="rightCol" class="w-[62%]">
        <div class="glass rounded-xl p-3 h-full flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <span class="text-sm text-[var(--muted)]">Förhandsvisning</span>
              <span id="liveDot" class="chip">LIVE</span>
            </div>
            <div class="flex items-center gap-2">
              <button id="openInNew" class="btn btn-ghost text-sm"><i class="fa-regular fa-up-right-from-square"></i> Öppna i ny flik</button>
              <button id="toggleFull" class="btn btn-ghost text-sm"><i class="fa-regular fa-minimize"></i> Full vy</button>
            </div>
          </div>
          <iframe id="preview" class="w-full h-[100%] bg-white rounded-lg border border-[var(--stroke)]"></iframe>
        </div>
      </section>
    </div>
  </main>

  <!-- Toasts -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden"></div>

<script>
/* --------------------------
   Helpers & UI
   -------------------------- */
const $ = (sel, el=document) => el.querySelector(sel);
function toast(msg, type='ok'){
  const t = $('#toast');
  t.className = "fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg glass border " +
                (type==='ok' ? "border-emerald-500 text-emerald-300" :
                 type==='error' ? "border-red-500 text-red-300" :
                 "border-[var(--stroke)] text-[var(--text)]");
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=> t.style.display = 'none', 2200);
}
$('#profileBtn').onclick = ()=> $('#profileMenu').classList.toggle('hidden');

/* --------------------------
   State & Tabs
   -------------------------- */
const fs = {
  pages: [],
  current: null
};
const tabs = $('#tabs');
function renderTabs(){
  tabs.innerHTML = '';
  fs.pages.forEach(p=>{
    const b = document.createElement('button');
    b.className = 'btn btn-ghost text-sm ' + (fs.current?.name===p.name ? 'ring-1 ring-[var(--brand-2)]' : '');
    b.textContent = p.name;
    b.onclick = ()=> setCurrent(p.name);
    tabs.appendChild(b);
  });
}
function addPage(name='ny.html', content=''){
  if(fs.pages.find(x=>x.name===name)){
    let i=2; while(fs.pages.find(x=>x.name===`${name.replace('.html','')}-${i}.html`)) i++;
    name = `${name.replace('.html','')}-${i}.html`;
  }
  fs.pages.push({name, content});
  setCurrent(name);
}
function setCurrent(name){
  fs.current = fs.pages.find(x=>x.name===name);
  $('#editor').value = fs.current.content || '';
  renderTabs(); writePreview();
}
$('#addTab').onclick = ()=> addPage();

/* --------------------------
   Preview writer
   - injicerar liten bridge (router) + tailwind fallback
   -------------------------- */
const preview = $('#preview');

function injectBridge(html){
  // router-brygga + klick fångare
  const bridge = `
<script>
  (function(){
    document.addEventListener('click', function(e){
      const a = e.target.closest('a[href]');
      if(!a) return;
      const href = a.getAttribute('href');
      if (!href) return;
      // bara interna psuedo-sidor
      if (href.endsWith('.html') || href.startsWith('#') || href === 'start' || href==='index.html'){
        e.preventDefault();
        parent.postMessage({type:'navigate', href: href==='start' ? 'index.html' : href}, '*');
      }
    }, true);
  })();
<\/script>`;

  let raw = String(html || '');

  // se till att vi har <html> etc.
  if(!/<!DOCTYPE|<html/i.test(raw)){
    raw = `<!DOCTYPE html><html lang="sv"><head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Förhandsvisning</title>
      <script src="https://cdn.tailwindcss.com"><\/script>
      <style> body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial} </style>
    </head><body>${raw}</body></html>`;
  } else {
    // lägg in Tailwind om saknas
    if(!/tailwindcss\.com\/?script/.test(raw)){
      raw = raw.replace(/<\/head>/i, `<script src="https://cdn.tailwindcss.com"><\/script></head>`);
    }
  }

  // injicera bridge innan </body>
  if (raw.includes('</body>')) raw = raw.replace('</body>', bridge + '</body>');
  else raw += bridge;

  return raw;
}

function writePreview(){
  if(!fs.current) return;
  const raw = injectBridge(fs.current.content || '');
  const blob = new Blob([raw], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  preview.src = url;
  preview.onload = ()=> URL.revokeObjectURL(url);
}

/* router från iframe */
window.addEventListener('message', (e)=>{
  if(e.data?.type==='navigate'){
    const name = e.data.href || 'index.html';
    const exists = fs.pages.find(p=>p.name===name);
    if(exists) setCurrent(name);
    else addPage(name, `<!DOCTYPE html><html><head><meta charset="utf-8">
      <title>${name}</title></head><body class="p-10">
      <h1 class="text-2xl font-bold">${name.replace('.html','')}</h1>
      <p>Tom sida – fyll på innehåll.</p>
      <p><a href="index.html" class="text-blue-600 underline">Tillbaka</a></p>
      </body></html>`);
  }
});

/* Editor actions */
$('#formatBtn').onclick = ()=>{
  let s = $('#editor').value
    .replace(/>\s+\n</g, '>\n<')
    .replace(/\n{3,}/g, '\n\n');
  $('#editor').value = s;
  if(fs.current) fs.current.content = s;
  writePreview();
};
$('#editor').addEventListener('input', ()=>{
  if(!fs.current) return;
  fs.current.content = $('#editor').value;
});
$('#updatePreview').onclick = writePreview;

/* Preview actions */
$('#openInNew').onclick = ()=>{
  if(!fs.current) return;
  const raw = injectBridge(fs.current.content || '');
  const blob = new Blob([raw], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
};
let full = false;
$('#toggleFull').onclick = ()=>{
  full = !full;
  if(full){
    preview.className = 'w-[95vw] h-[85vh] fixed inset-0 z-[60] m-auto bg-white rounded-xl border border-[var(--stroke)]';
    document.body.style.overflow = 'hidden';
  } else {
    preview.className = 'w-full h-[100%] bg-white rounded-lg border border-[var(--stroke)]';
    document.body.style.overflow = '';
  }
};

/* --------------------------
   AI integrationer
   -------------------------- */
async function explainCode(){
  if(!fs.current) return;
  try{
    const r = await fetch('/api/openai', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type:'explain', code: fs.current.content || '' })
    });
    const j = await r.json();
    $('#expBody').classList.remove('hidden');
    $('#expBody').textContent = j.reply || 'Kunde inte få svar.';
  }catch(e){ toast('AI-förklaring misslyckades', 'error'); }
}

async function improveCurrent(message){
  if(!fs.current) return;
  const code = fs.current.content || '';
  try{
    // 1) Först DeepSite "improve"
    const r = await fetch('/api/deepsite', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ mode:'improve', prompt: message, html: code })
    });
    const j = await r.json().catch(()=> ({}));
    let html = j?.html || j?.files?.[0]?.content || '';

    if(html && /<html|<body|<head|<!DOCTYPE/i.test(html)){
      $('#editor').value = html;
      fs.current.content = html;
      writePreview();
      toast('Design förbättrad', 'ok');
      return;
    }

    // 2) Fallback: OpenAI
    const r2 = await fetch('/api/openai', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type:'improve', message, code })
    });
    const j2 = await r2.json().catch(()=> ({}));
    if(j2?.reply){
      $('#editor').value = j2.reply;
      fs.current.content = j2.reply;
      writePreview();
      toast('Förbättring (fallback)', 'ok');
    } else {
      toast('AI kunde inte förbättra koden.', 'error');
    }
  }catch(e){
    toast('Fel vid förbättring', 'error');
  }
}

async function refineBrief(raw){
  try{
    const r = await fetch('/api/openai', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type:'brief', message: raw })
    });
    const j = await r.json();
    return j.reply || raw;
  }catch{
    return raw;
  }
}

async function generateSite(raw){
  const refined = await refineBrief(raw);
  try{
    const r = await fetch('/api/deepsite', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ mode:'generate', prompt: refined })
    });
    const j = await r.json().catch(()=> ({}));

    let html = '';
    if (Array.isArray(j?.files) && j.files.length){
      // om flera filer, plocka index.html först
      const idx = j.files.find(f=>/index\.html$/i.test(f.name)) || j.files[0];
      fs.pages = j.files.map(f=> ({ name: f.name || 'index.html', content: f.content || '' }));
      html = idx.content || '';
      setCurrent(idx.name || 'index.html');
    } else if (j?.html) {
      html = j.html;
      fs.pages = [{ name:'index.html', content: html }];
      setCurrent('index.html');
    } else {
      // fallback – åtminstone visa brief sammanfattad
      html = `<!DOCTYPE html><html><head><meta charset="utf-8">
        <title>Genererad sida</title>
        <script src="https://cdn.tailwindcss.com"></script>
        </head><body class="p-10">
        <h1 class="text-2xl font-bold mb-2">Genererad sida</h1>
        <p class="text-slate-600">Kunde inte hämta full HTML från AI just nu. Här är din brief:</p>
        <pre class="mt-4 p-4 bg-slate-100 rounded">${refined.replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]))}</pre>
        </body></html>`;
      fs.pages = [{ name:'index.html', content: html }];
      setCurrent('index.html');
    }

    writePreview();
    toast('Sida genererad', 'ok');
  }catch(e){
    toast('Kunde inte generera design', 'error');
  }
}

/* Buttons */
$('#explainBtn').onclick = explainCode;
$('#improveBtn').onclick = ()=> improveCurrent('Förbättra design, layout, hierarki, tillgänglighet och responsivitet. Håll det modernt och rent.');
$('#applyImprove').onclick = ()=>{
  const m = $('#aiPrompt').value.trim();
  if(!m) return toast('Skriv vad som ska ändras.', 'error');
  improveCurrent(m);
};
$('#generateSite').onclick = ()=>{
  const p = $('#aiPrompt').value.trim();
  if(!p) return toast('Skriv vad du vill skapa.', 'error');
  generateSite(p);
};

/* Nytt / Export */
$('#newProject').onclick = ()=>{
  fs.pages = [{
    name:'index.html',
    content: `<!DOCTYPE html><html lang="sv"><head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Startklar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    </head><body class="p-10">
      <h1 class="text-2xl font-bold">Startklar</h1>
      <p>Beskriv vad du vill bygga i AI-rutan och klicka <strong>Generera</strong>, eller klistra in befintlig kod i editorn.</p>
    </body></html>`
  }];
  setCurrent('index.html');
  writePreview();
};
$('#saveProject').onclick = ()=>{
  const zip = { files: fs.pages.reduce((acc,p)=> (acc[p.name]=p.content, acc), {}) };
  const blob = new Blob([JSON.stringify(zip,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'webneva-project.json'; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 1500);
};

/* Init – läs ev. query från index (quiz) */
(function init(){
  fs.pages = [{
    name:'index.html',
    content: `<!DOCTYPE html><html><head><meta charset="utf-8">
    <title>Genererad sida</title><script src="https://cdn.tailwindcss.com"></script></head>
    <body class="p-10">
      <h1 class="text-2xl font-bold">Genererad sida</h1>
      <p class="text-slate-600">Klistra in din HTML i editorn eller generera en helt ny sajt till vänster.</p>
    </body></html>`
  }];
  setCurrent('index.html'); writePreview();

  const u = new URL(location.href);
  const mode = u.searchParams.get('mode');
  const prompt = u.searchParams.get('prompt');
  const hasCode = u.searchParams.get('hasCode') === '1';
  const code = u.searchParams.get('code');
  if(prompt) $('#aiPrompt').value = prompt;

  if(mode==='improve' && hasCode && code){
    try{
      const raw = decodeURIComponent(escape(atob(code)));
      fs.pages = [{ name:'index.html', content: raw }];
      setCurrent('index.html'); writePreview();
    }catch{}
  }
  if(mode==='generate' && prompt){
    generateSite(prompt);
  }
})();

/* Drag-resize (desktop) */
(function splitDrag(){
  const bar = $('#dragbar');
  if(!bar) return;
  const left = $('#leftCol'), right = $('#rightCol');
  let dragging = false;
  bar.addEventListener('mousedown', ()=> dragging = true);
  window.addEventListener('mouseup', ()=> dragging = false);
  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    const rect = document.body.getBoundingClientRect();
    let x = e.clientX - rect.left;
    x = Math.max(340, Math.min(x, rect.width - 520));
    const leftW = x - 8, rightW = rect.width - x - 8;
    left.style.width = leftW + 'px';
    right.style.width = rightW + 'px';
  });
})();
</script>
</body>
</html>
