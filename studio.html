<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Webneva Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="images/bgk-remove.webneva.png"/>
  <style>
    :root{
      --brand:#2f57ff;         /* prim√§r bl√• (lik HuggingFace/DeepSite vibe) */
      --brand-2:#00e1ff;       /* accent cyan */
      --ink:#0f172a;           /* text */
      --ink-2:#334155;         /* sekund√§r text */
      --bg-1:#0b1020;          /* m√∂rk bakgrund */
      --panel:#0f1428;         /* panelbackgrund */
      --ring:rgba(47,87,255,.4);
    }
    html,body{height:100%}
    body{
      background: radial-gradient(1200px 600px at 20% -10%, rgba(0,225,255,.08), transparent 60%),
                  radial-gradient(1000px 500px at 80% -20%, rgba(47,87,255,.12), transparent 60%),
                  var(--bg-1);
      color:#e5e7eb;
    }
    .glass{background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06)}
    .btn{display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .9rem; border-radius:.7rem; font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#0b1020}
    .btn-soft{background:rgba(255,255,255,.06); color:#e5e7eb; border:1px solid rgba(255,255,255,.08)}
    .btn-soft:hover{background:rgba(255,255,255,.09)}
    .chip{font-size:.7rem; padding:.2rem .45rem; border-radius:.5rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1)}
    .ring{box-shadow:0 0 0 .2rem var(--ring)}
    .tab{padding:.35rem .6rem; border-radius:.5rem; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.04)}
    .tab.active{background:rgba(47,87,255,.15); border-color:rgba(47,87,255,.3)}
    textarea{caret-color:var(--brand)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body class="antialiased">
  <!-- Topbar -->
  <header class="sticky top-0 z-30 backdrop-blur border-b border-white/5 bg-black/30">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="images/bgk-remove.webneva.png" class="h-7 w-7" alt="Webneva"/>
        <div class="font-extrabold tracking-tight">Webneva <span class="text-cyan-300">Studio</span>
          <span class="chip ml-2">LIVE</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="newProject" class="btn btn-soft"><span>üÜï</span>Nytt projekt</button>
        <button id="saveProject" class="btn btn-soft"><span>‚¨áÔ∏è</span>Exportera</button>
        <a href="/" class="btn btn-primary"><span>üè†</span>Startida</a>
      </div>
    </div>
  </header>

  <!-- Main grid -->
  <main class="max-w-7xl mx-auto px-4 py-4">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Left: Editor + AI -->
      <section id="leftCol" class="glass rounded-2xl p-4">
        <!-- Tabs -->
        <div class="flex items-center justify-between">
          <div id="tabs" class="flex flex-wrap gap-2"></div>
          <button id="addTab" class="btn btn-soft">+ Ny sida</button>
        </div>

        <!-- Editor -->
        <div class="mt-3">
          <label class="text-sm text-slate-300">HTML / CSS / JS</label>
          <textarea id="editor" rows="18"
                    class="mt-2 w-full mono rounded-xl p-3 bg-black/40 border border-white/8 focus:outline-none focus:ring-2 focus:ring-[--ring] text-slate-200"
                    placeholder="Klistra in din HTML h√§r..."></textarea>
          <div class="flex items-center gap-2 mt-2">
            <button id="formatBtn" class="btn btn-soft">Formatera</button>
            <button id="updatePreview" class="btn btn-soft">Uppdatera</button>
          </div>
        </div>

        <!-- AI controls -->
        <div class="mt-6">
          <div class="text-sm text-slate-300 flex items-center gap-2">
            <span>AI-assistent</span> <span class="chip">DeepSite + ChatGPT</span>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <input id="aiPrompt" type="text"
              class="flex-1 rounded-xl px-3 py-2 bg-black/40 border border-white/8 focus:outline-none focus:ring-2 focus:ring-[--ring]"
              placeholder="Beskriv vad du vill bygga (t.ex. 'Skapa en restaurang-sida med bokning, r√∂d/svart tema')."/>
            <button id="generateSite" class="btn btn-primary">Generera</button>
          </div>
          <div class="mt-2 flex flex-wrap gap-2">
            <button id="improveBtn" class="btn btn-soft">‚ú® F√∂rb√§ttra aktuell kod</button>
            <button id="explainBtn" class="btn btn-soft">ü§ñ F√∂rklara koden</button>
            <button id="applyImprove" class="btn btn-soft">üîß Applicera instruktion</button>
          </div>

          <!-- AI explanations -->
          <details id="expander" class="mt-4">
            <summary class="cursor-pointer text-slate-300">AI-f√∂rklaringar</summary>
            <div id="explainBox" class="mt-2 text-sm text-slate-200/90 whitespace-pre-wrap"></div>
          </details>
        </div>
      </section>

      <!-- Right: Preview -->
      <section id="rightCol" class="glass rounded-2xl p-4 relative">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-slate-300">F√∂rhandsvisning</div>
          <div class="flex items-center gap-2">
            <button id="openInNew" class="btn btn-soft">√ñppna i ny flik</button>
            <button id="toggleFull" class="btn btn-primary">Full vy</button>
          </div>
        </div>
        <div class="relative">
          <iframe id="preview" title="webneva-preview"
                  class="w-full h-[75vh] rounded-xl bg-white"></iframe>
        </div>
      </section>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden z-50 px-4 py-2 rounded-xl text-sm font-semibold"></div>

  <script>
    /* =======================
       Minimal ‚Äúfil-system‚Äù
       ======================= */
    const fs = {
      pages: [],
      current: null // {name, content}
    };
    const $ = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>[...p.querySelectorAll(s)];

    function renderTabs(){
      const wrap = $('#tabs'); wrap.innerHTML = '';
      fs.pages.forEach(p=>{
        const b = document.createElement('button');
        b.className = 'tab ' + (fs.current && fs.current.name===p.name ? 'active':'');
        b.textContent = p.name;
        b.onclick = ()=> setCurrent(p.name);
        wrap.appendChild(b);
      });
    }

    function setCurrent(name){
      const page = fs.pages.find(p=>p.name===name);
      if(!page) return;
      fs.current = page;
      $('#editor').value = page.content;
      renderTabs();
      writePreview();
    }

    function addPage(name='ny-sida.html', content=''){
      if (fs.pages.some(p=>p.name===name)) {
        let i=2; let base=name.replace(/\.html$/,'');
        while(fs.pages.some(p=>p.name===`${base}-${i}.html`)) i++;
        name = `${base}-${i}.html`;
      }
      fs.pages.push({name,content});
      setCurrent(name);
    }

    /* =======================
       Preview writer + bridge
       ======================= */
    // Liten router-brygga: inga backticks -> s√§ker injicering
    const BRIDGE = '<script>(function(){try{\
      function to(e,s){e.addEventListener(s,ev=>ev.stopPropagation(),true)};\
      document.addEventListener(\"click\",function(e){\
        var a=e.target.closest(\"a[href]\"); if(!a)return;\
        var href=a.getAttribute(\"href\"); if(!href)return;\
        if(href.endsWith(\".html\")){ e.preventDefault(); parent.postMessage({type:\"navigate\",href:href},\"*\"); }\
      },true);\
      to(document,\"click\");\
    }catch(_e){}})();<\/script>';

    function ensureTailwind(html){
      if (/cdn\.tailwindcss\.com/.test(html)) return html;
      // injicera tailwind efter <head> eller f√∂re </head>
      const tag = '<script src="https://cdn.tailwindcss.com"><\\/script>';
      if (/<head[^>]*>/i.test(html)) return html.replace(/<head[^>]*>/i, m => m + tag);
      if (/<\\/head>/i.test(html)) return html.replace(/<\\/head>/i, tag + '</head>');
      return tag + html;
    }

    function wrapHTML(html){
      let raw = html || '';
      // l√§gg till router-brygga + tailwind om de saknas
      raw = ensureTailwind(raw);
      if (!/<script[^>]*>.*parent\.postMessage/.test(raw)) {
        // injicera bridge strax f√∂re </body> om det finns, annars sist
        if (/<\\/body>/i.test(raw)) raw = raw.replace(/<\\/body>/i, BRIDGE + '</body>');
        else raw += BRIDGE;
      }
      return raw;
    }

    function writePreview(){
      const iframe = $('#preview');
      if (!fs.current) return;
      const raw = wrapHTML(fs.current.content);
      const blob = new Blob([raw], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      iframe.src = url;
      iframe.onload = ()=> URL.revokeObjectURL(url);
    }

    // Router fr√•n preview
    window.addEventListener('message', (e)=>{
      if (e.data && e.data.type === 'navigate') {
        const target = e.data.href || 'index.html';
        const exists = fs.pages.find(p=>p.name===target);
        if (exists) setCurrent(target);
        else {
          addPage(target, '<!doctype html><html><head><meta charset="utf-8"><script src="https://cdn.tailwindcss.com"><\\/script><title>'+target+'</title></head><body class="p-8"><h1 class="text-3xl font-bold mb-2">'+target.replace('.html','')+'</h1><p>Tom sida ‚Äì fyll p√• inneh√•ll.</p><p class="mt-4"><a href="index.html" class="text-blue-600 underline">Tillbaka</a></p></body></html>');
        }
      }
    });

    /* =======================
       UI actions
       ======================= */
    $('#editor').addEventListener('input', ()=>{
      if (!fs.current) return;
      fs.current.content = $('#editor').value;
    });
    $('#updatePreview').onclick = ()=> writePreview();

    $('#formatBtn').onclick = ()=>{
      let s = $('#editor').value
        .replace(/>\\s+\\n</g, '><')       // ta bort tomma rader mellan taggar
        .replace(/\\n{3,}/g,'\\n\\n');     // max tv√• radbryt
      $('#editor').value = s;
      if (fs.current) fs.current.content = s;
      writePreview();
    };

    $('#addTab').onclick = ()=> addPage();

    $('#openInNew').onclick = ()=>{
      if (!fs.current) return;
      const b = new Blob([fs.current.content], {type:'text/html'});
      const u = URL.createObjectURL(b);
      window.open(u, '_blank', 'noopener');
      setTimeout(()=> URL.revokeObjectURL(u), 1500);
    };

    let full = false;
    $('#toggleFull').onclick = ()=>{
      full = !full;
      const ifr = $('#preview');
      if (full) {
        ifr.className = 'fixed inset-2 z-[60] rounded-2xl w-[calc(100vw-1rem)] h-[calc(100vh-1rem)] bg-white';
        document.body.style.overflow = 'hidden';
        $('#toggleFull').textContent = 'St√§ng full vy';
      } else {
        ifr.className = 'w-full h-[75vh] rounded-xl bg-white';
        document.body.style.overflow = '';
        $('#toggleFull').textContent = 'Full vy';
      }
    };

    function toast(msg, ok=true){
      const t = $('#toast');
      t.textContent = msg;
      t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-xl text-sm font-semibold ' +
        (ok ? 'bg-emerald-400/20 text-emerald-200 border border-emerald-400/40' :
              'bg-rose-400/20 text-rose-200 border border-rose-400/40');
      t.style.display = 'block';
      setTimeout(()=> t.style.display='none', 2200);
    }

    /* =======================
       AI-integrationer
       ======================= */
    async function explainCode(){
      if (!fs.current) return;
      try{
        const r = await fetch('/api/openai', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ type:'explain', code: fs.current.content })
        });
        const j = await r.json();
        $('#explainBox').textContent = j.reply || 'Kunde inte f√• svar.';
        $('details#expander').open = true;
      }catch(_e){
        toast('AI-f√∂rklaring misslyckades', false);
      }
    }

    async function improveCurrent(message){
      if (!fs.current) return;
      try{
        // F√∂rst DeepSite (HTML in ‚Üí HTML ut)
        const r = await fetch('/api/deepsite', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mode:'improve', prompt: message, html: fs.current.content })
        });
        const j = await r.json();
        // DeepSite kan returnera {html} eller {files:[{name,content}]}
        const html = j?.html || (j?.files && j.files[0]?.content);
        if (html){
          fs.current.content = html;
          $('#editor').value = html;
          writePreview();
          toast('Design f√∂rb√§ttrad');
          return;
        }
        // Fallback: OpenAI returnerar HTML i .reply
        const r2 = await fetch('/api/openai', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ type:'improve', message, code: fs.current.content })
        });
        const j2 = await r2.json();
        if (j2?.reply){
          fs.current.content = j2.reply;
          $('#editor').value = j2.reply;
          writePreview();
          toast('F√∂rb√§ttring (fallback) applicerad');
        } else {
          toast('AI kunde inte f√∂rb√§ttra koden.', false);
        }
      }catch(_e){
        toast('Fel vid f√∂rb√§ttring', false);
      }
    }

    async function refineBrief(raw){
      try{
        const r = await fetch('/api/openai', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ type:'brief', message: raw })
        });
        const j = await r.json();
        return j.reply || raw;
      }catch{ return raw; }
    }

    async function generateSite(rawPrompt){
      if (!rawPrompt) return toast('Skriv vad du vill skapa.', false);
      try{
        const refined = await refineBrief(rawPrompt);
        const r = await fetch('/api/deepsite', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mode:'generate', prompt: refined })
        });
        const j = await r.json();
        if (j?.files?.length){
          fs.pages = j.files.map(f=>({ name: f.name || 'index.html', content: f.content || '' }));
          setCurrent(fs.pages[0].name);
          renderTabs();
          writePreview();
          toast('Sida genererad');
          return;
        }
        if (j?.html){
          fs.pages = [{name:'index.html', content:j.html}];
          setCurrent('index.html');
          renderTabs();
          writePreview();
          toast('Sida genererad');
          return;
        }
        // Fallback: visa brief p√• sidan om inget HTML kom
        const safe = (refined+'').replace(/[<>&]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]));
        const html = '<!doctype html><html><head><meta charset="utf-8"><script src="https://cdn.tailwindcss.com"><\\/script><title>Genererad sida<\/title></head><body class="p-8 max-w-3xl mx-auto"><h1 class="text-3xl font-bold mb-4">Genererad sida<\/h1><p class="text-slate-600">Kunde inte h√§mta full HTML fr√•n AI just nu. H√§r √§r din brief:<\/p><pre class="mt-3 p-3 bg-slate-50 border rounded text-slate-800">'+safe+'<\/pre><\/body><\/html>';
        fs.pages = [{ name:'index.html', content: html }];
        setCurrent('index.html');
        renderTabs();
        writePreview();
        toast('Sida genererad (fallback)');
      }catch(_e){
        toast('Kunde inte generera design', false);
      }
    }

    // Buttons
    $('#explainBtn').onclick = explainCode;
    $('#improveBtn').onclick = ()=> improveCurrent('F√∂rb√§ttra design, layout, hierarki, tillg√§nglighet och responsivitet. H√•ll det modernt och rent.');
    $('#applyImprove').onclick = ()=>{
      const m = $('#aiPrompt').value.trim();
      if (!m) return toast('Skriv vad som ska √§ndras.', false);
      improveCurrent(m);
    };
    $('#generateSite').onclick = ()=>{
      const p = $('#aiPrompt').value.trim();
      generateSite(p);
    };

    // Topbar: nytt & export
    $('#newProject').onclick = ()=>{
      fs.pages = [{ name:'index.html', content:
        '<!doctype html><html><head><meta charset="utf-8"><script src="https://cdn.tailwindcss.com"><\\/script><title>Startklar<\/title></head><body class="p-8"><h1 class="text-3xl font-bold mb-2">Startklar<\/h1><p class="text-slate-600">Beskriv vad du vill bygga i AI-f√§ltet och klicka <em>Generera<\/em>, eller klistra in befintlig kod i editorn.<\/p><\/body><\/html>'
      }];
      setCurrent('index.html'); renderTabs(); writePreview();
      toast('Nytt projekt klart');
    };

    $('#saveProject').onclick = ()=>{
      const zip = { files: fs.pages.reduce((acc,p)=> (acc[p.name]=p.content, acc), {}) };
      const blob = new Blob([JSON.stringify(zip,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'webneva-project.json'; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1200);
      toast('Projekt exporterat');
    };

    /* =======================
       Init (query fr√•n index)
       ======================= */
    (function init(){
      fs.pages = [{ name:'index.html', content:
        '<!doctype html><html><head><meta charset="utf-8"><script src="https://cdn.tailwindcss.com"><\\/script><title>Startklar<\/title></head><body class="p-8 max-w-3xl mx-auto"><h1 class="text-3xl font-bold mb-2">Startklar<\/h1><p class="text-slate-600">Klistra in din HTML i editorn eller generera en helt ny sajt via AI till v√§nster.<\/p><\/body><\/html>'
      }];
      setCurrent('index.html'); renderTabs(); writePreview();

      const u = new URL(location.href);
      const mode = u.searchParams.get('mode');
      const prompt = u.searchParams.get('prompt');
      const hasCode = u.searchParams.get('hasCode') === '1';
      const code = u.searchParams.get('code');

      if (prompt) $('#aiPrompt').value = prompt;

      if (mode==='improve' && hasCode && code){
        try{
          const raw = decodeURIComponent(escape(atob(code)));
          fs.pages = [{ name:'index.html', content: raw }];
          setCurrent('index.html'); renderTabs(); writePreview();
        }catch(_e){}
      }
      if (mode==='generate' && prompt){
        generateSite(prompt);
      }
    })();
  </script>
</body>
</html>
