<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webneva Studio</title>
  <link rel="icon" href="images/bgk-remove.webneva.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root {
      --dark:#0d1117;--panel:#0f1420;--border:#1f2937;
      --text:#e5e7eb;--blue:#3b82f6;--blue-strong:#2563eb;
    }
    html,body{height:100%;margin:0}
    body{font-family:'Inter',sans-serif;background:var(--dark);color:var(--text);overflow:hidden}
    .btn{padding:.4rem .8rem;border:1px solid var(--border);border-radius:6px;
         font-size:.85rem;background:transparent;color:var(--text)}
    .btn:hover{background:rgba(255,255,255,.05)}
    .btn-primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn-primary:hover{background:var(--blue-strong)}
    .thinking{background:linear-gradient(90deg,transparent,rgba(59,130,246,.1),transparent);
      background-size:200% 100%;animation:shimmer 1.8s linear infinite}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="flex items-center justify-between px-4 h-12 border-b border-[#1f2937] bg-[#0e1320]">
    <div class="flex items-center gap-2">
      <img src="images/bgk-remove.webneva.png" class="h-5 w-5" alt="Webneva">
      <span class="font-semibold text-sm">Webneva Studio</span>
    </div>
    <div class="flex gap-2">
      <button id="btnNew" class="btn">Nytt</button>
      <button id="btnExport" class="btn">Exportera</button>
      <a href="index.html" class="btn">Startsida</a>
    </div>
  </header>

  <!-- Main split -->
  <main class="grid grid-cols-[25%_75%] h-[calc(100vh-3rem)]">
    <!-- Editor -->
    <section class="flex flex-col bg-[#0f1420] border-r border-[#1f2937]">
      <div class="flex items-center justify-between px-3 h-10 border-b border-[#1f2937]">
        <span class="text-sm text-slate-300">index.html</span>
        <button id="btnAddTab" class="btn">+</button>
      </div>
      <div id="editorHost" class="flex-1 overflow-hidden"></div>

      <!-- Prompt -->
      <div class="border-t border-[#1f2937] p-3">
        <div class="flex items-center gap-2 mb-2">
          <select id="aiMode" class="bg-[#0b0f19] border border-[#1f2937] rounded-md text-sm px-2 py-1">
            <option value="generate">Generera ny sida</option>
            <option value="improve">Förbättra aktuell kod</option>
          </select>
          <div id="aiStatus" class="ml-auto text-xs text-slate-400 hidden">AI genererar…</div>
        </div>
        <div class="flex items-stretch gap-2">
          <textarea id="aiPrompt"
            class="flex-1 resize-none h-20 px-3 py-3 rounded-md bg-[#0b0f19] border border-[#1f2937]
                   text-sm outline-none focus:border-[#2a3a63]"
            placeholder="Skriv din prompt här och tryck Enter eller klicka Skicka"></textarea>
          <button id="btnSend" class="btn-primary px-4">Skicka</button>
        </div>
      </div>
    </section>

    <!-- Preview -->
    <section class="relative bg-gradient-to-br from-[#eef2ff] to-[#e6efff]">
      <div class="flex items-center justify-between px-3 h-10 border-b border-[#c7d4f8] bg-white/60 backdrop-blur">
        <div class="font-semibold text-slate-700 text-sm">Live Preview</div>
        <div class="flex gap-2">
          <button id="btnOpen" class="btn text-slate-700 border-[#ccd6f6]">Ny flik</button>
          <button id="btnFull" class="btn text-slate-700 border-[#ccd6f6]">Fullskärm</button>
        </div>
      </div>
      <iframe id="preview" class="absolute inset-0 top-10 w-full h-[calc(100%-2.5rem)] bg-white border-0"></iframe>
      <div id="overlay" class="hidden absolute top-10 left-0 right-0 h-1 thinking"></div>
    </section>
  </main>

  <!-- CodeMirror + logic -->
  <script type="module">
    import {EditorState} from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.4.1/dist/index.js";
    import {EditorView,keymap} from "https://cdn.jsdelivr.net/npm/@codemirror/view@6.29.1/dist/index.js";
    import {defaultKeymap,history,historyKeymap} from "https://cdn.jsdelivr.net/npm/@codemirror/commands@6.6.2/dist/index.js";
    import {html} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-html@6.4.9/dist/index.js";
    import {oneDark} from "https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.2.0/dist/index.js";
    import {aiGenerate,aiImprove} from "./js/ai.js";

    let currentHTML = "<!doctype html><html lang='sv'><head><meta charset='utf-8'><title>Ny sida</title><script src='https://cdn.tailwindcss.com'><\\/script></head><body class='p-10'><h1 class='text-3xl font-bold'>Webneva Studio</h1></body></html>";

    const state = EditorState.create({
      doc: currentHTML,
      extensions: [
        history(), keymap.of([...defaultKeymap,...historyKeymap]), html(), oneDark,
        EditorView.updateListener.of(update=>{
          if(update.docChanged){
            currentHTML = update.state.doc.toString();
            updatePreview();
          }
        })
      ]
    });
    const view = new EditorView({state,parent:document.getElementById("editorHost")});
    const iframe=document.getElementById("preview");
    const overlay=document.getElementById("overlay");
    const aiPrompt=document.getElementById("aiPrompt");
    const aiStatus=document.getElementById("aiStatus");
    const aiMode=document.getElementById("aiMode");

    function ensureTW(html){
      if(!/cdn\.tailwindcss\.com/.test(html)){
        const tw='<script src="https://cdn.tailwindcss.com"><\\/script>';
        return html.replace(/<head>/i,`<head>${tw}`);
      }
      return html;
    }
    function updatePreview(){
      const blob=new Blob([ensureTW(currentHTML)],{type:"text/html"});
      iframe.src=URL.createObjectURL(blob);
    }
    updatePreview();

    function setThinking(on){
      aiStatus.classList.toggle("hidden",!on);
      overlay.classList.toggle("hidden",!on);
    }

    async function sendPrompt(){
      const prompt=aiPrompt.value.trim();
      if(!prompt)return;
      setThinking(true);
      try{
        let html;
        if(aiMode.value==="generate"){ html=await aiGenerate(prompt); }
        else{ html=await aiImprove(prompt,currentHTML); }

        console.log("AI returned:",html.slice(0,200));
        if(!/<html[\s\S]*<\/html>/i.test(html)) throw new Error("API svarade inte med komplett HTML");
        view.dispatch({changes:{from:0,to:view.state.doc.length,insert:html}});
        aiPrompt.value="";
      }catch(e){
        console.error("AI error",e);
        alert("Fel: "+e.message);
      }finally{ setThinking(false); }
    }

    document.getElementById("btnSend").addEventListener("click",sendPrompt);
    aiPrompt.addEventListener("keydown",e=>{
      if(e.key==="Enter"&&!e.shiftKey){
        e.preventDefault();
        sendPrompt();
      }
    });

    // top buttons
    document.getElementById("btnNew").onclick=()=>{
      if(confirm("Starta nytt projekt?")){
        view.dispatch({changes:{from:0,to:view.state.doc.length,insert:currentHTML}});
      }
    };
    document.getElementById("btnExport").onclick=()=>{
      const blob=new Blob([currentHTML],{type:"text/html"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="webneva-projekt.html";
      a.click();
    };
    document.getElementById("btnOpen").onclick=()=>{
      const blob=new Blob([currentHTML],{type:"text/html"});
      window.open(URL.createObjectURL(blob),"_blank");
    };
    document.getElementById("btnFull").onclick=()=>iframe.requestFullscreen?.();
  </script>
</body>
</html>
