<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webneva Studio</title>
  <link rel="icon" href="images/bgk-remove.webneva.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root{ --dark:#0b1120; --panel:#0f172a; --border:#1f2940; --text:#e6e9ef; --muted:#94a3b8; --blue:#2563eb; --blue2:#3b82f6 }
    html,body{height:100%} body{font-family:Inter,system-ui;background:var(--dark);color:var(--text);overflow:hidden}
    .btn{border:1px solid var(--border);border-radius:10px;padding:.55rem .85rem;font-weight:700}
    .btn:hover{background:#0e1530}
    .btn-primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn-primary:hover{background:var(--blue2)}
    .thinking{background:linear-gradient(90deg,transparent,rgba(37,99,235,.16),transparent);background-size:200% 100%;animation:shimmer 1.6s linear infinite}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    .tag{font-size:.7rem;border:1px solid var(--border);padding:.1rem .5rem;border-radius:.5rem;color:#9ec1ff;background:rgba(37,99,235,.15)}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="flex items-center justify-between px-4 h-12 border-b border-[var(--border)] bg-[#0e1428]">
    <div class="flex items-center gap-2">
      <img src="images/bgk-remove.webneva.png" class="h-5 w-5" alt="Webneva">
      <span class="font-semibold text-sm">Webneva Studio</span>
      <span class="tag ml-2">OpenAI</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnNew" class="btn">Nytt</button>
      <button id="btnExport" class="btn">Exportera</button>
      <a class="btn" href="index.html">Startsida</a>
    </div>
  </header>

  <!-- Main 25/75 -->
  <main class="grid grid-cols-[28%_72%] h-[calc(100vh-3rem)]">
    <!-- Left: Summary + Editor + Prompt -->
    <section class="flex flex-col bg-[var(--panel)] border-r border-[var(--border)]">
      <!-- Summary -->
      <div class="px-4 py-3 border-b border-[var(--border)]">
        <div class="text-xs text-[var(--muted)]">Val från onboarding</div>
        <div id="summary" class="mt-2 text-sm space-y-1 max-h-24 overflow-auto"></div>
      </div>

      <!-- Editor host -->
      <div id="editorHost" class="flex-1 overflow-hidden"></div>

      <!-- Prompt -->
      <div class="border-t border-[var(--border)] p-3">
        <div class="flex items-center gap-2 mb-2">
          <div class="text-xs text-[var(--muted)]">AI-prompt</div>
          <div id="aiStatus" class="ml-auto text-xs text-[var(--muted)] hidden">AI arbetar…</div>
        </div>
        <div class="flex items-stretch gap-2">
          <textarea id="aiPrompt" class="flex-1 resize-none h-20 px-3 py-3 rounded-md bg-[#0c1327] border border-[var(--border)] text-sm outline-none focus:border-[var(--blue)]" placeholder="Beskriv vad du vill – Enter skickar (Shift+Enter radbrytning)"></textarea>
          <button id="btnSend" class="btn-primary px-4">Skicka</button>
        </div>
        <div class="text-[12px] text-[var(--muted)] mt-2">Exempel: “Skapa mörk SaaS-landningssida med hero, 3 features och CTA.”</div>
      </div>
    </section>

    <!-- Right: Preview -->
    <section class="relative bg-gradient-to-br from-[#eef2ff] to-[#e6efff]">
      <div class="flex items-center justify-between px-3 h-10 border-b border-[#c7d4f8] bg-white/70 backdrop-blur">
        <div class="font-semibold text-slate-700 text-sm">Live Preview</div>
        <div class="flex items-center gap-2">
          <button id="btnOpen" class="btn text-slate-700 border-[#ccd6f6]">Ny flik</button>
          <button id="btnFull" class="btn text-slate-700 border-[#ccd6f6]">Fullskärm</button>
        </div>
      </div>
      <iframe id="preview" class="absolute inset-0 top-10 w-full h-[calc(100%-2.5rem)] bg-white border-0"></iframe>
      <div id="overlay" class="hidden absolute top-10 left-0 right-0 h-1 thinking"></div>
    </section>
  </main>

  <!-- Code + Logic -->
  <script type="module">
    import { EditorState } from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.4.1/dist/index.js";
    import { EditorView, keymap } from "https://cdn.jsdelivr.net/npm/@codemirror/view@6.29.1/dist/index.js";
    import { defaultKeymap, history, historyKeymap } from "https://cdn.jsdelivr.net/npm/@codemirror/commands@6.6.2/dist/index.js";
    import { html } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-html@6.4.9/dist/index.js";
    import { oneDark } from "https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.2.0/dist/index.js";
    import { aiGenerate, aiImprove } from "./js/ai.js";

    const SETUP_KEY = "WEBNEVA_SETUP_V1";
    const setup = safeGetSetup();

    function safeGetSetup(){ try{ return JSON.parse(localStorage.getItem(SETUP_KEY)||"null"); }catch{ return null; } }

    // Summary render
    const summaryEl=document.getElementById("summary");
    function renderSummary(){
      summaryEl.innerHTML="";
      if(!setup?.answers){ summaryEl.innerHTML='<div class="text-[var(--muted)] text-xs">Inga val (kör onboarding på index)</div>'; return; }
      Object.entries(setup.answers).forEach(([k,v])=>{
        const val=Array.isArray(v)?v.join(", "):(v||"—");
        const row=document.createElement("div"); row.className="flex justify-between gap-2";
        row.innerHTML=`<span class="text-[var(--muted)]">${k}</span><span class="font-semibold">${val}</span>`;
        summaryEl.appendChild(row);
      });
    }
    renderSummary();

    // Compose initial prompt from setup
    function initialPromptFromSetup(){
      if(!setup?.answers) return "";
      const a=setup.answers;
      return `Skapa en komplett, responsiv webbplats.
Syfte: ${a.purpose||"—"}
Sidor: ${(Array.isArray(a.pages)?a.pages.join(", "):a.pages)||"Startsida, Kontakt"}
Stil: ${a.style||"Mörk & lyxig"}
Fokus: ${a.focus||"Bra typografi, CTA, hero, features"}
Använd Tailwind, mörk/blå stil, svensk microcopy.
Returnera en enda fullständig HTML-fil.`;
    }

    // Starter doc (så något syns direkt)
    let currentHTML = "<!doctype html><html lang='sv'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>Webneva</title><script src='https://cdn.tailwindcss.com'><\\/script></head><body class='bg-slate-50 text-slate-900'><main class='max-w-5xl mx-auto p-10'><h1 class='text-3xl font-bold'>Webneva Studio</h1><p class='mt-3 text-slate-600'>Skriv i editorn eller använd AI-prompten nedan. Om du kom via quiz kör AI:n strax automatiskt.</p></main></body></html>";

    // Editor
    const editorView = new EditorView({
      state: EditorState.create({
        doc: currentHTML,
        extensions: [
          history(), keymap.of([...defaultKeymap, ...historyKeymap]), html(), oneDark,
          EditorView.updateListener.of(u => { if(u.docChanged){ currentHTML=u.state.doc.toString(); updatePreview(); }})
        ]
      }),
      parent: document.getElementById("editorHost")
    });

    // Preview
    const iframe = document.getElementById("preview");
    function ensureTW(html){
      return /cdn\.tailwindcss\.com/.test(html) ? html : html.replace(/<head>/i, "<head><script src='https://cdn.tailwindcss.com'><\\/script>");
    }
    function updatePreview(){
      const blob = new Blob([ensureTW(currentHTML)], { type:"text/html" });
      iframe.src = URL.createObjectURL(blob);
    }
    updatePreview();

    // AI controls
    const aiPrompt = document.getElementById("aiPrompt");
    const aiStatus = document.getElementById("aiStatus");
    const overlay  = document.getElementById("overlay");
    const btnSend  = document.getElementById("btnSend");
    function thinking(on){ aiStatus.classList.toggle("hidden",!on); overlay.classList.toggle("hidden",!on); }

    async function runGenerate(p){
      thinking(true);
      try{
        const html = await aiGenerate(p);
        editorView.dispatch({ changes:{ from:0, to:editorView.state.doc.length, insert: html } });
      }catch(e){ alert("AI-fel: "+e.message); console.error(e); }
      finally{ thinking(false); }
    }
    async function runImprove(p, html){
      thinking(true);
      try{
        const res = await aiImprove(p, html);
        editorView.dispatch({ changes:{ from:0, to:editorView.state.doc.length, insert: res } });
      }catch(e){ alert("AI-fel: "+e.message); console.error(e); }
      finally{ thinking(false); }
    }

    // Send/Enter
    async function send(){
      const p = aiPrompt.value.trim(); if(!p) return;
      // förbättra nuvarande HTML om dokumentet innehåller något mer än default
      const substantial = (currentHTML || "").length > 200;
      if(substantial) await runImprove(p, currentHTML); else await runGenerate(p);
      aiPrompt.value="";
    }
    btnSend.onclick = send;
    aiPrompt.addEventListener("keydown", e => { if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); } });

    // Auto-run från quiz
    if (setup?.autoRun) {
      const p = initialPromptFromSetup();
      aiPrompt.value = p;
      runGenerate(p);
      localStorage.setItem(SETUP_KEY, JSON.stringify({ ...setup, autoRun:false }));
    }

    // Toolbar
    document.getElementById("btnNew").onclick = () => {
      if(!confirm("Starta nytt dokument?")) return;
      const fresh="<!doctype html><html lang='sv'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>Nytt projekt</title><script src='https://cdn.tailwindcss.com'><\\/script></head><body class='bg-slate-50 text-slate-900'><main class='max-w-5xl mx-auto p-10'><h1 class='text-3xl font-bold'>Nytt projekt</h1></main></body></html>";
      editorView.dispatch({ changes:{ from:0, to:editorView.state.doc.length, insert: fresh } });
    };
    document.getElementById("btnExport").onclick = () => {
      const blob=new Blob([currentHTML],{type:"text/html"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="webneva-projekt.html"; a.click();
    };
    document.getElementById("btnOpen").onclick = () => {
      const blob=new Blob([currentHTML],{type:"text/html"});
      window.open(URL.createObjectURL(blob), "_blank");
    };
    document.getElementById("btnFull").onclick = () => document.getElementById("preview").requestFullscreen?.();
  </script>
</body>
</html>
