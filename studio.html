<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webneva Studio – AI-driven webbutveckling</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: "#0f4c81", 600:"#0c3b63", 700:"#0a2e4a" }
          },
          boxShadow: {
            sheet: "0 10px 30px rgba(2,12,27,.08)"
          }
        }
      }
    }
  </script>

  <!-- Ikoner -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    html,body { height:100%; }
    body { background: #0b1220; }
    /* Scrollbars lite smalare i editorn */
    .thin-scroll::-webkit-scrollbar{ width:8px;height:8px }
    .thin-scroll::-webkit-scrollbar-thumb{ background:#1f2937;border-radius:8px }
    .thin-scroll::-webkit-scrollbar-track{ background:transparent }
    /* Draggable split (mobil fallback döljer den) */
    #dragbar{ width:8px; cursor:col-resize; background:transparent }
    #dragbar:hover{ background:#243142 }
    /* Overlay spinner */
    .spinner{ border:3px solid rgba(255,255,255,.2); border-top-color:#fff; border-radius:50%; width:22px; height:22px; animation:spin 0.8s linear infinite }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="text-slate-100 antialiased">

  <!-- Topbar -->
  <header class="sticky top-0 z-40 backdrop-blur bg-[#0b1220]/70 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="images/bgk-remove.webneva.png" alt="Webneva" class="h-7 w-7 object-contain rounded-sm">
        <span class="text-lg font-extrabold tracking-tight">Webneva <span class="text-brand/90">Studio</span></span>
        <span class="ml-2 inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-300">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span> LIVE
        </span>
      </div>

      <nav class="flex items-center gap-2">
        <button id="newProject" class="px-3 py-1.5 text-sm bg-slate-800/70 hover:bg-slate-700 rounded-md border border-white/10">
          <i class="fa-solid fa-plus mr-1"></i> Nytt projekt
        </button>
        <button id="saveProject" class="px-3 py-1.5 text-sm bg-slate-800/70 hover:bg-slate-700 rounded-md border border-white/10">
          <i class="fa-solid fa-box-archive mr-1"></i> Exportera
        </button>

        <div class="relative">
          <button id="profileBtn" class="px-3 py-1.5 text-sm bg-slate-800/70 hover:bg-slate-700 rounded-md border border-white/10">
            <i class="fa-solid fa-user mr-1"></i> Profil <i class="fa-solid fa-chevron-down ml-1 opacity-70"></i>
          </button>
          <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 rounded-lg border border-white/10 bg-slate-900 shadow-xl">
            <div class="px-4 py-3 text-xs text-slate-300">Inställningar</div>
            <button class="block w-full text-left px-4 py-2 text-sm hover:bg-slate-800/60">Min profil</button>
            <button class="block w-full text-left px-4 py-2 text-sm hover:bg-slate-800/60">Projekthistorik</button>
            <button class="block w-full text-left px-4 py-2 text-sm hover:bg-slate-800/60">Tema</button>
          </div>
        </div>

        <a href="index.html" class="ml-1 px-3 py-1.5 text-sm bg-brand hover:bg-brand-600 rounded-md shadow-sm border border-white/10">
          Startida
        </a>
      </nav>
    </div>
  </header>

  <!-- Workbench -->
  <main class="max-w-[1600px] mx-auto px-4 py-5">
    <div class="grid grid-cols-12 gap-4">

      <!-- Left Column -->
      <section id="leftCol" class="col-span-12 lg:col-span-5 flex flex-col gap-4">

        <!-- Tabs (pages) -->
        <div class="rounded-xl border border-white/10 bg-slate-900/70 shadow-sheet">
          <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
            <div class="text-xs uppercase tracking-wider text-slate-400">Sidor</div>
            <button id="addTab" class="text-xs px-2 py-1 rounded-md bg-slate-800 hover:bg-slate-700 border border-white/10">
              <i class="fa-solid fa-plus mr-1"></i> Ny sida
            </button>
          </div>
          <div id="tabs" class="px-3 py-2 flex flex-wrap gap-2"></div>
        </div>

        <!-- Editor card -->
        <div class="rounded-xl border border-white/10 bg-slate-900/70 shadow-sheet">
          <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
            <div class="text-xs uppercase tracking-wider text-slate-400">HTML / CSS / JS</div>
            <div class="flex items-center gap-1">
              <button id="formatBtn" class="text-xs px-2 py-1 rounded-md bg-slate-800 hover:bg-slate-700 border border-white/10">
                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Formatera
              </button>
              <button id="updatePreview" class="text-xs px-2 py-1 rounded-md bg-slate-800 hover:bg-slate-700 border border-white/10">
                <i class="fa-solid fa-rotate mr-1"></i> Uppdatera
              </button>
            </div>
          </div>
          <textarea id="editor"
                    spellcheck="false"
                    class="thin-scroll w-full h-[420px] bg-[#0c1424] text-slate-100 px-4 py-3 outline-none resize-none font-mono text-[13px] leading-6 rounded-b-xl"
                    placeholder="Din HTML här..."></textarea>

          <!-- AI bottom controls (à la DeepSite) -->
          <div class="px-4 pb-4 space-y-3">
            <div class="text-xs uppercase tracking-wider text-slate-400">AI-assistent</div>

            <div class="flex items-center gap-2">
              <input id="aiPrompt"
                     class="flex-1 px-3 py-2 rounded-md bg-slate-800/70 border border-white/10 outline-none focus:ring-2 ring-brand/40"
                     placeholder="Beskriv vad du vill bygga, så skapar AI hela sidan (t.ex. 'Skapa en restaurang-sajt, mål: fler bokningar, färgtema: röd & svart, sidor: Start, Boka, Kontakt')">
              <button id="generateSite" class="px-3 py-2 text-sm rounded-md bg-emerald-600 hover:bg-emerald-700">
                <i class="fa-solid fa-bolt mr-1"></i> Generera
              </button>
            </div>

            <div class="flex items-center gap-2">
              <button id="improveBtn" class="px-3 py-2 text-sm rounded-md bg-sky-600 hover:bg-sky-700">
                <i class="fa-solid fa-sparkles mr-1"></i> Förbättra
              </button>
              <button id="explainBtn" class="px-3 py-2 text-sm rounded-md bg-slate-700 hover:bg-slate-600">
                <i class="fa-regular fa-message mr-1"></i> Förklara koden
              </button>
              <button id="applyImprove" class="px-3 py-2 text-sm rounded-md bg-brand hover:bg-brand-600">
                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Applicera instruktion
              </button>
            </div>

            <div id="explainBox" class="hidden rounded-lg border border-white/10 bg-slate-800/40 p-3 text-sm text-slate-300"></div>
          </div>
        </div>

      </section>

      <!-- Dragbar (desktop) -->
      <div id="dragbar" class="hidden lg:block col-span-0"></div>

      <!-- Right Column: Preview -->
      <section id="rightCol" class="col-span-12 lg:col-span-7">
        <div class="rounded-xl border border-white/10 bg-slate-900/70 shadow-sheet overflow-hidden flex flex-col">
          <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
            <div class="text-xs uppercase tracking-wider text-slate-400">Förhandsvisning</div>
            <div class="flex items-center gap-2">
              <button id="openInNew" class="text-xs px-2 py-1 rounded-md bg-slate-800 hover:bg-slate-700 border border-white/10">
                <i class="fa-solid fa-up-right-from-square mr-1"></i> Öppna i ny flik
              </button>
              <button id="toggleFull" class="text-xs px-2 py-1 rounded-md bg-slate-800 hover:bg-slate-700 border border-white/10">
                <i class="fa-solid fa-maximize mr-1"></i> Full vy
              </button>
            </div>
          </div>

          <div class="relative">
            <iframe id="preview"
                    class="w-full h-[720px] bg-white"
                    title="live-preview"
                    sandbox="allow-forms allow-scripts allow-same-origin allow-popups"></iframe>

            <div id="busy" class="hidden absolute inset-0 bg-black/20 backdrop-blur-sm grid place-items-center">
              <div class="flex items-center gap-3 text-sm">
                <div class="spinner"></div>
                <span>Genererar…</span>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Explanations Accordion -->
        <div class="mt-4 rounded-xl border border-white/10 bg-slate-900/70 shadow-sheet">
          <button id="expToggle" class="w-full px-4 py-3 border-b border-white/10 text-left text-sm hover:bg-slate-800/40">
            <i class="fa-solid fa-chevron-right mr-2" id="expIcon"></i> AI-förklaringar
          </button>
          <div id="expBody" class="hidden p-4 text-sm text-slate-300">
            Här visas AI:s kommentarer om din kod. Klicka på <em>Förklara koden</em> för att generera en översikt.
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 hidden z-50">
    <div class="px-4 py-2 rounded-lg bg-slate-900 border border-white/10 shadow-xl text-sm"></div>
  </div>

  <script>
  // ---------- DOM helpers ----------
  const $ = sel => document.querySelector(sel);
  const busy = (on) => { $('#busy').classList.toggle('hidden', !on); };
  const toast = (msg, type='info') => {
    const el = $('#toast'); const box = el.firstElementChild;
    box.textContent = msg;
    box.className = "px-4 py-2 rounded-lg shadow-xl text-sm border " +
      (type==='error' ? "bg-red-900/80 border-red-400" :
       type==='ok'    ? "bg-emerald-900/70 border-emerald-400" :
                        "bg-slate-900/90 border-white/10");
    el.classList.remove('hidden');
    setTimeout(()=> el.classList.add('hidden'), 2600);
  };

  // ---------- App state ----------
  const fs = { pages: [], current: null };
  const editor = $('#editor');
  const preview= $('#preview');

  // Tabs
  function renderTabs(){
    const wrap = $('#tabs'); wrap.innerHTML = '';
    fs.pages.forEach(p => {
      const btn = document.createElement('button');
      btn.className = 'px-3 py-1.5 rounded-md text-sm border border-white/10 ' +
        (fs.current?.name===p.name ? 'bg-slate-800' : 'bg-slate-900 hover:bg-slate-800');
      btn.textContent = p.name;
      btn.onclick = ()=> setCurrent(p.name);
      wrap.appendChild(btn);
    });
  }
  function setCurrent(name){
    const f = fs.pages.find(x=>x.name===name); if(!f) return;
    fs.current = f;
    editor.value = f.content;
    writePreview(name);
    renderTabs();
  }
  function addPage(name='ny-sida.html', content='<!doctype html><html lang="sv"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Ny sida</title><script src="https://cdn.tailwindcss.com"></script></head><body class="min-h-screen grid place-items-center bg-slate-50 text-slate-800"><main class="max-w-5xl mx-auto p-6"><h1 class="text-3xl font-bold mb-2">Ny sida</h1><p>Redigera innehållet i editorn.</p></main></body></html>'){
    fs.pages.push({ name, content });
    setCurrent(name);
  }

  // Preview writer: injicera liten router-brygga + Tailwind fallback
  function writePreview(route){
    const bridge = `
<script>
  (function(){
    // fånga interna navigeringar
    document.addEventListener('click', function(e){
      const a = e.target.closest('a');
      if(!a) return;
      const href = a.getAttribute('href') || '';
      if(href && !href.startsWith('http') && !href.startsWith('mailto:') && !href.startsWith('#')){
        e.preventDefault(); parent.postMessage({type:'navigate', href: href.replace(/^\\/?/,'')}, '*');
      }
    }, true);
  })();
<\/script>`;
    const page = fs.pages.find(p=>p.name===route) || fs.current || fs.pages[0];
    let raw = page?.content || '';

    // se till att vi har en komplett HTML
    const hasHtml = /<\s*html/i.test(raw);
    if(!hasHtml){
      raw = `<!doctype html><html lang="sv"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Förhandsvisning</title><script src="https://cdn.tailwindcss.com"></script></head><body class="bg-white text-slate-800"><main class="max-w-5xl mx-auto p-6">${raw}</main>${bridge}</body></html>`;
    } else {
      raw = raw.includes('</body>') ? raw.replace('</body>', bridge+'</body>') : raw + bridge;
      if(!/tailwindcss\.com\/?script/.test(raw)){
        // injicera CDN om det saknas
        raw = raw.replace(/<head[^>]*>/i, m => `${m}\n<script src="https://cdn.tailwindcss.com"></script>`);
      }
    }

    const blob = new Blob([raw], {type:'text/html'});
    const url  = URL.createObjectURL(blob);
    preview.src = url;
    preview.onload = ()=> URL.revokeObjectURL(url);
  }

  // Router från preview
  window.addEventListener('message', (e)=>{
    if(e.data?.type==='navigate'){
      const target = e.data.href || 'index.html';
      const exists = fs.pages.find(p=>p.name===target);
      if(exists) { setCurrent(target); }
      else { addPage(target, `<!doctype html><html lang="sv"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>${target}</title><script src="https://cdn.tailwindcss.com"></script></head><body class="min-h-screen bg-slate-50 text-slate-800"><main class="max-w-5xl mx-auto p-8"><h1 class="text-2xl font-bold mb-3">${target.replace('.html','')}</h1><p>Tom sida – fyll på innehåll.</p><a href="index.html" class="inline-block mt-6 text-brand underline">Tillbaka</a></main></body></html>`); }
    }
  });

  // Format button
  $('#formatBtn').onclick = ()=>{
    let s = editor.value.replace(/>\s+\n</g, '>\n<').replace(/\n{3,}/g, '\n\n');
    editor.value = s;
    if(fs.current) fs.current.content = s;
    writePreview();
  };
  // Update live as you type (light)
  editor.addEventListener('input', ()=>{
    if(!fs.current) return;
    fs.current.content = editor.value;
  });
  $('#updatePreview').onclick = ()=> writePreview();

  // Top right actions
  $('#openInNew').onclick = ()=>{
    if(!fs.current) return;
    const blob = new Blob([fs.current.content], {type:'text/html'});
    const url  = URL.createObjectURL(blob);
    window.open(url, '_blank');
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  };
  let full = false;
  $('#toggleFull').onclick = ()=>{
    full = !full;
    preview.className = full ? 'w-[95vw] h-[82vh] bg-white fixed inset-0 z-[60] m-auto rounded-lg shadow-2xl' : 'w-full h-[720px] bg-white';
    document.body.style.overflow = full ? 'hidden' : '';
  };

  // Profile dropdown
  $('#profileBtn').onclick = ()=> $('#profileMenu').classList.toggle('hidden');

  // Accordion
  $('#expToggle').onclick = ()=>{
    const body = $('#expBody'); const icon = $('#expIcon');
    body.classList.toggle('hidden');
    icon.classList.toggle('fa-chevron-right');
    icon.classList.toggle('fa-chevron-down');
  };

  // ---------- AI integrations ----------
  async function explainCode(){
    if(!fs.current) return;
    try{
      const r = await fetch('/api/openai', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type:'explain', code: fs.current.content })
      });
      const j = await r.json();
      $('#explainBox').classList.remove('hidden');
      $('#explainBox').textContent = j.reply || 'Kunde inte få svar.';
      $('#expBody').innerHTML = `<pre class="whitespace-pre-wrap text-slate-200">${(j.reply||'').replace(/[<>&]/g,m=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[m]))}</pre>`;
    }catch(e){ toast('AI-förklaring misslyckades', 'error'); }
  }
  async function improveCurrent(message){
    if(!fs.current) return;
    busy(true);
    try{
      // 1) be DeepSite förbättra (HTML in → HTML ut)
      const r = await fetch('/api/deepsite', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ mode:'improve', prompt: message, html: fs.current.content })
      });
      const j = await r.json();
      if(j?.html){
        editor.value = j.html;
        fs.current.content = j.html;
        writePreview();
        busy(false); toast('Design förbättrad', 'ok'); return;
      }
      // 2) fallback: OpenAI returnerar HTML
      const r2 = await fetch('/api/openai', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type:'improve', message, code: fs.current.content })
      });
      const j2 = await r2.json();
      if(j2?.reply){
        editor.value = j2.reply;
        fs.current.content = j2.reply;
        writePreview();
        toast('Förbättring (fallback) applicerad', 'ok');
      } else {
        toast('AI kunde inte förbättra koden.', 'error');
      }
    }catch(e){
      toast('Fel vid förbättring', 'error');
    } finally { busy(false); }
  }

  async function refineBrief(raw){
    // frivillig: förtydliga briefen innan bygge (OpenAI)
    try{
      const r = await fetch('/api/openai', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type:'brief', message: raw })
      });
      const j = await r.json();
      return j.reply || raw;
    }catch{ return raw; }
  }

  async function generateSite(raw){
    busy(true);
    try{
      const refined = await refineBrief(raw);
      const r = await fetch('/api/deepsite', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ mode:'generate', prompt: refined })
      });
      const j = await r.json();

      if(j?.html){
        fs.pages = [{ name:'index.html', content: j.html }];
        setCurrent('index.html');
        renderTabs();
        writePreview();
        toast('Sida genererad', 'ok');
      } else {
        toast('Kunde inte generera design automatiskt', 'error');
      }
    }catch(e){
      toast('Fel vid generering', 'error');
    } finally { busy(false); }
  }

  // Buttons
  $('#explainBtn').onclick = explainCode;
  $('#improveBtn').onclick = ()=> improveCurrent('Förbättra design, layout, hierarki, tillgänglighet och responsivitet. Håll det modernt och rent.');
  $('#applyImprove').onclick = ()=>{
    const m = $('#aiPrompt').value.trim();
    if(!m) return toast('Skriv vad som ska ändras.', 'error');
    improveCurrent(m);
  };
  $('#generateSite').onclick = ()=>{
    const p = $('#aiPrompt').value.trim();
    if(!p) return toast('Skriv vad du vill skapa.', 'error');
    generateSite(p);
  };
  $('#addTab').onclick = ()=> addPage();

  // Topbar: nytt & export
  $('#newProject').onclick = ()=>{
    fs.pages = [{
      name:'index.html',
      content:`<!doctype html><html lang="sv"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Nytt projekt</title><script src="https://cdn.tailwindcss.com"></script></head><body class="min-h-screen bg-slate-50 text-slate-800"><main class="max-w-5xl mx-auto p-8"><h1 class="text-2xl font-bold mb-2">Startklar</h1><p>Beskriv vad du vill bygga i fältet till vänster och klicka <em>Generera</em>, eller klistra in befintlig kod och klicka <em>Uppdatera</em>.</p></main></body></html>`
    }];
    setCurrent('index.html'); renderTabs(); writePreview();
  };
  $('#saveProject').onclick = ()=>{
    const zip = { files: fs.pages.reduce((acc,p)=> (acc[p.name]=p.content, acc), {}) };
    const blob = new Blob([JSON.stringify(zip,null,2)], {type:'application/json'});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='webneva-project.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  };

  // Init — fyll sidan
  (function init(){
    fs.pages = [{
      name:'index.html',
      content:`<!doctype html><html lang="sv"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Genererad sida</title><script src="https://cdn.tailwindcss.com"></script></head><body class="bg-white text-slate-800"><main class="max-w-5xl mx-auto p-8"><h1 class="text-2xl font-bold mb-2">Genererad sida</h1><p class="text-slate-600">Klistra in din HTML i editorn eller generera en helt ny sajt till vänster.</p></main></body></html>`
    }];
    setCurrent('index.html'); renderTabs(); writePreview();

    // Om du kommer från index med query
    const u = new URL(location.href);
    const mode   = u.searchParams.get('mode');
    const prompt = u.searchParams.get('prompt');
    const hasCode= u.searchParams.get('hasCode') === '1';
    const code   = u.searchParams.get('code');

    if(prompt) $('#aiPrompt').value = prompt;

    if(mode === 'improve' && hasCode && code){
      // Base64-kodad HTML → in i editorn
      try{
        const raw = decodeURIComponent(escape(atob(code)));
        fs.pages = [{ name:'index.html', content: raw }];
        setCurrent('index.html'); writePreview();
      }catch{}
    }
    if(mode === 'generate' && prompt){
      generateSite(prompt);
    }
  })();

  // Dragbar (desktop): valfritt
  (function splitDrag(){
    const bar = $('#dragbar'); const left = $('#leftCol'); const right = $('#rightCol');
    if(!bar) return;
    let dragging = false;
    bar.addEventListener('mousedown', ()=> dragging=true);
    window.addEventListener('mouseup', ()=> dragging=false);
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      const rect = document.body.getBoundingClientRect();
      let x = e.clientX - rect.left;
      x = Math.max(320, Math.min(x, rect.width-480));
      const percent = x / rect.width;
      left.style.gridColumnEnd = 'span 0';
      right.style.gridColumnEnd= 'span 0';
      left.style.width  = `calc(${percent*100}% - 8px)`;
      right.style.width = `calc(${(1-percent)*100}% - 8px)`;
    });
  })();

  </script>
</body>
</html>
