<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webneva Studio</title>
  <link rel="icon" href="images/bgk-remove.webneva.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root {
      --dark: #0d1117;
      --panel: #0f1420;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --blue: #3b82f6;
      --blue-strong: #2563eb;
    }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--dark);
      color: var(--text);
      overflow: hidden;
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .btn { padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 6px;
           font-size: 0.85rem; color: var(--text); background: transparent; transition: .2s; }
    .btn:hover { background: rgba(255,255,255,0.05); }
    .btn-primary { background: var(--blue); border-color: var(--blue); color: white; }
    .btn-primary:hover { background: var(--blue-strong); }
    .thinking { background: linear-gradient(90deg,transparent,rgba(59,130,246,.1),transparent);
                background-size:200% 100%; animation: shimmer 2s linear infinite; }
    @keyframes shimmer { 0%{background-position:-200% 0}100%{background-position:200% 0} }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="flex items-center justify-between px-4 h-12 border-b border-[#1f2937] bg-[#0e1320]">
    <div class="flex items-center gap-2">
      <img src="images/bgk-remove.webneva.png" class="h-5 w-5" alt="Webneva">
      <span class="font-semibold text-sm">Webneva Studio</span>
      <span class="ml-2 text-xs text-emerald-400 flex items-center gap-1">
        <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> LIVE
      </span>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnNew" class="btn">Nytt</button>
      <button id="btnExport" class="btn">Exportera</button>
      <a href="index.html" class="btn">Startsida</a>
    </div>
  </header>

  <!-- Main area -->
  <main class="grid grid-cols-[20%_80%] h-[calc(100vh-3rem)]">
    <!-- Left side: Editor + AI -->
    <section class="flex flex-col bg-[#0f1420] border-r border-[#1f2937]">
      <div class="flex items-center justify-between px-3 h-10 border-b border-[#1f2937]">
        <span class="text-sm text-slate-300">index.html</span>
        <button id="btnAddTab" class="btn">+</button>
      </div>
      <div id="editorHost" class="flex-1 overflow-hidden"></div>

      <!-- AI bar -->
      <div class="border-t border-[#1f2937] p-3">
        <div class="flex items-center gap-2 mb-2">
          <select id="aiMode" class="bg-[#0b0f19] border border-[#1f2937] rounded-md text-sm px-2 py-1">
            <option value="generate">Generera ny sida</option>
            <option value="improve">Förbättra aktuell kod</option>
          </select>
          <div id="aiStatus" class="text-xs text-slate-400 ml-auto hidden">AI genererar…</div>
        </div>
        <div class="flex items-stretch gap-2">
          <textarea id="aiPrompt" class="flex-1 resize-none h-12 px-3 py-2 rounded-md bg-[#0b0f19] border border-[#1f2937] text-sm outline-none focus:border-[#2a3a63]" placeholder="Skriv din prompt och tryck Enter eller Skicka"></textarea>
          <button id="btnSend" class="btn-primary px-4">Skicka</button>
        </div>
      </div>
    </section>

    <!-- Right side: Live preview -->
    <section class="relative bg-gradient-to-br from-[#eef2ff] to-[#e6efff]">
      <div class="flex items-center justify-between px-3 h-10 border-b border-[#c7d4f8] bg-white/60 backdrop-blur">
        <div class="font-semibold text-slate-700 text-sm">Live Preview</div>
        <div class="flex items-center gap-2">
          <button id="btnOpen" class="btn text-slate-700 border-[#ccd6f6]">Ny flik</button>
          <button id="btnFull" class="btn text-slate-700 border-[#ccd6f6]">Fullskärm</button>
        </div>
      </div>
      <iframe id="preview" class="absolute inset-0 top-10 w-full h-[calc(100%-2.5rem)] bg-white border-0"></iframe>
      <div id="overlay" class="hidden absolute top-10 left-0 right-0 h-1 thinking"></div>
    </section>
  </main>

  <!-- CodeMirror + Logic -->
  <script type="module">
    import { EditorState } from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.4.1/dist/index.js";
    import { EditorView, keymap } from "https://cdn.jsdelivr.net/npm/@codemirror/view@6.29.1/dist/index.js";
    import { defaultKeymap, history, historyKeymap } from "https://cdn.jsdelivr.net/npm/@codemirror/commands@6.6.2/dist/index.js";
    import { html } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-html@6.4.9/dist/index.js";
    import { oneDark } from "https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.2.0/dist/index.js";
    import { aiGenerate, aiImprove } from "./js/ai.js";

    let currentHTML = "<!doctype html><html lang='sv'><head><meta charset='utf-8'><title>Ny sida</title><script src='https://cdn.tailwindcss.com'><\\/script></head><body class='bg-slate-50 text-slate-900 p-10'><h1 class='text-4xl font-bold'>Webneva Studio</h1><p class='mt-4 text-slate-600'>Börja skriva eller använd AI.</p></body></html>";

    const editorHost = document.getElementById("editorHost");
    const state = EditorState.create({
      doc: currentHTML,
      extensions: [history(), keymap.of([...defaultKeymap, ...historyKeymap]), html(), oneDark,
        EditorView.updateListener.of(update => {
          if (update.docChanged) {
            currentHTML = update.state.doc.toString();
            updatePreview();
          }
        })
      ],
    });
    const view = new EditorView({ state, parent: editorHost });

    const iframe = document.getElementById("preview");
    const overlay = document.getElementById("overlay");
    const aiPrompt = document.getElementById("aiPrompt");
    const aiStatus = document.getElementById("aiStatus");
    const aiMode = document.getElementById("aiMode");

    function ensureTailwind(html){
      if(!/cdn\.tailwindcss\.com/.test(html)){
        const tw = '<script src="https://cdn.tailwindcss.com"><\\/script>';
        return html.replace(/<head>/i, `<head>${tw}`);
      }
      return html;
    }
    function updatePreview(){
      const blob = new Blob([ensureTailwind(currentHTML)],{type:"text/html"});
      const url = URL.createObjectURL(blob);
      iframe.src = url;
    }
    updatePreview();

    function setThinking(on){
      aiStatus.classList.toggle("hidden", !on);
      overlay.classList.toggle("hidden", !on);
    }

    async function doSend(){
      const prompt = aiPrompt.value.trim();
      if(!prompt) return;
      setThinking(true);
      try{
        let html;
        if(aiMode.value === "generate") html = await aiGenerate(prompt);
        else html = await aiImprove(prompt, currentHTML);

        if(!/<html[\s\S]*<\/html>/i.test(html)) throw new Error("Ogiltig HTML");
        view.dispatch({ changes:{from:0, to:view.state.doc.length, insert:html} });
        aiPrompt.value = "";
      }catch(e){
        alert("Fel: " + e.message);
      }finally{
        setThinking(false);
      }
    }

    document.getElementById("btnSend").addEventListener("click", doSend);
    aiPrompt.addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); doSend(); }
    });

    document.getElementById("btnNew").onclick=()=>{ if(confirm("Starta nytt projekt?")){ view.dispatch({changes:{from:0,to:view.state.doc.length,insert:currentHTML}});} };
    document.getElementById("btnExport").onclick=()=>{ const blob=new Blob([currentHTML],{type:"text/html"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="webneva-projekt.html"; a.click(); };
    document.getElementById("btnOpen").onclick=()=>{ const blob=new Blob([currentHTML],{type:"text/html"}); const url=URL.createObjectURL(blob); window.open(url,"_blank"); };
    document.getElementById("btnFull").onclick=()=>{ iframe.requestFullscreen?.(); };
  </script>
</body>
</html>
