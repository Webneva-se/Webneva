<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Webneva Studio – AI-driven webbutveckling</title>
<link rel="icon" href="images/bgk-remove.webneva.png" />
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<style>
  :root { --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --brand:#4463ff; }
  body{background:linear-gradient(160deg,#0a0f1c 0%,#0b1220 40%,#0d1426 100%); color:#e5e7eb;}
  .glass{background:rgba(15,23,42,.85); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.06);}
  .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);}
  .badge{background:rgba(68,99,255,.15); color:#aebdff; border:1px solid rgba(68,99,255,.25);}
  .btn{background:#2b3348; border:1px solid rgba(255,255,255,.08);}
  .btn:hover{background:#333b52;}
  .btn-brand{background:linear-gradient(180deg,#5a73ff,#3f5aff); border:0;}
  .btn-brand:hover{filter:brightness(1.1);}
  .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  /* Layout: vänster panel sticky, förhandsvisning enorm till höger */
  .left-col{width:420px;}
  @media (max-width: 1100px){ .left-col{width:100%; position:static;} }
  iframe{background:white; border-radius:18px;}
  /* Fullscreen overlay */
  .fullscreen-wrap{position:fixed; inset:0; display:none; background:rgba(9,12,21,.9); z-index:70; padding:20px;}
  .fullscreen-wrap.active{display:block;}
</style>
</head>
<body class="antialiased">

<!-- Topbar -->
<header class="sticky top-0 z-50 px-4 py-3 bg-[#0b1220]/70 backdrop-blur border-b border-white/5">
  <div class="max-w-[1500px] mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="images/bgk-remove.webneva.png" alt="Webneva" class="h-8 w-8">
      <div class="text-lg font-extrabold tracking-tight">Webneva <span class="text-indigo-300">Studio</span></div>
      <span class="ml-3 badge px-2 py-0.5 rounded text-xs">LIVE</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="newProject" class="btn px-3 py-1.5 rounded text-sm"><i class="fa-regular fa-file"></i> Nytt projekt</button>
      <button id="exportProject" class="btn px-3 py-1.5 rounded text-sm"><i class="fa-solid fa-download"></i> Exportera</button>
      <a href="/" class="btn px-3 py-1.5 rounded text-sm"><i class="fa-solid fa-house"></i> Startida</a>
    </div>
  </div>
</header>

<!-- Huvudlayout -->
<main class="max-w-[1500px] mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-[420px_1fr] gap-6">

  <!-- Vänster: sidor + editor + prompt -->
  <aside class="left-col glass rounded-2xl shadow-soft p-4 lg:sticky lg:top-[84px] self-start">
    <!-- Sidor -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold text-sm text-slate-300">Sidor</h3>
        <button id="addTab" class="btn px-2 py-1 rounded text-xs"><i class="fa-solid fa-plus"></i> Ny sida</button>
      </div>
      <div id="tabBar" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Editor -->
    <section>
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold text-sm text-slate-300">HTML / CSS / JS</h3>
        <div class="flex items-center gap-2 text-xs">
          <button id="formatBtn" class="btn px-2 py-1 rounded"><i class="fa-solid fa-wand-magic-sparkles"></i> Formatera</button>
          <button id="updatePreview" class="btn px-2 py-1 rounded"><i class="fa-solid fa-rotate-right"></i> Uppdatera</button>
        </div>
      </div>
      <textarea id="editor" rows="18" class="w-full code bg-[#0c1323] border border-white/10 focus:border-white/20 focus:ring-0 rounded-xl p-3 text-sm" placeholder="Din HTML här..."></textarea>
    </section>

    <!-- Prompt-ruta (lilla, under editorn) -->
    <section class="mt-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold text-sm text-slate-300">AI-assistent</h3>
        <div class="text-[10px] text-slate-400">Tips: skriv vad du vill bygga/ändra.</div>
      </div>
      <div class="flex items-center gap-2">
        <input id="aiPrompt" class="flex-1 code bg-[#0c1323] border border-white/10 rounded-lg px-3 py-2 text-xs" placeholder="Ex: Skapa en företagssida. Mål: få bokningar. Färgtema: röd & svart. Sidor: Start, Boka, Kontakt.">
        <button id="generateSite" class="btn-brand px-3 py-2 rounded text-xs font-semibold"><i class="fa-solid fa-bolt"></i> Generera</button>
      </div>
      <div class="flex gap-2 mt-2">
        <button id="improveBtn" class="btn px-3 py-1.5 rounded text-xs"><i class="fa-solid fa-sparkles"></i> Förbättra</button>
        <button id="explainBtn" class="btn px-3 py-1.5 rounded text-xs"><i class="fa-regular fa-message"></i> Förklara koden</button>
        <button id="applyImprove" class="btn px-3 py-1.5 rounded text-xs"><i class="fa-solid fa-check"></i> Applicera</button>
      </div>
      <details class="mt-3">
        <summary class="text-xs text-slate-400 cursor-pointer">AI-förklaringar</summary>
        <div id="explanations" class="text-xs text-slate-300 mt-2 whitespace-pre-wrap"></div>
      </details>
    </section>
  </aside>

  <!-- Höger: Preview (stor datorvy) -->
  <section class="glass rounded-2xl shadow-soft p-3">
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-slate-300 font-semibold">Förhandsvisning</div>
      <div class="flex items-center gap-2">
        <button id="openNew" class="btn px-2 py-1 rounded text-xs"><i class="fa-regular fa-window-restore"></i> Öppna i ny flik</button>
        <button id="fullscreen" class="btn px-2 py-1 rounded text-xs"><i class="fa-solid fa-expand"></i> Full vy</button>
      </div>
    </div>
    <div class="relative">
      <iframe id="preview" class="w-full h-[78vh] lg:h-[84vh] transition-all duration-300"></iframe>
    </div>
  </section>
</main>

<!-- Fullscreen overlay -->
<div id="fs_wrap" class="fullscreen-wrap">
  <div class="h-full w-full">
    <iframe id="fs_iframe" class="w-full h-full rounded-xl bg-white"></iframe>
  </div>
  <button id="fs_close" class="absolute top-4 right-4 btn px-3 py-1.5 rounded"><i class="fa-solid fa-xmark"></i> Stäng</button>
</div>

<script>
/* =====================================================================================
   Webneva Studio – klientlogik (DeepSite + ChatGPT hybrid)
   ===================================================================================== */

const $ = (sel) => document.querySelector(sel);

// ------------------------------
// Enkel filstruktur i minne
// ------------------------------
const fs = {
  pages: [],          // [{name, content}]
  current: null       // aktuell sida (objekt)
};

function addPage(name = 'ny-sida.html', content = `<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${name.replace('.html','')}</title>
<link rel="stylesheet" href="https://cdn.tailwindcss.com?plugins=forms,typography">
</head>
<body class="bg-slate-50">
<main class="max-w-5xl mx-auto p-6">
  <h1 class="text-3xl font-bold">Tom sida: ${name}</h1>
  <p class="text-slate-600 mt-2">Fyll på med innehåll eller generera via AI.</p>
</main>
</body>
</html>`){
  fs.pages.push({name, content});
  setCurrent(name);
  renderTabs();
}

function setCurrent(name){
  const found = fs.pages.find(p=>p.name===name) || fs.pages[0];
  fs.current = found;
  $('#editor').value = found?.content || '';
  writePreview(found?.name);
  highlightActiveTab();
}

function renderTabs(){
  const host = $('#tabBar');
  host.innerHTML = '';
  fs.pages.forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'px-2 py-1 rounded text-xs border border-white/10 hover:border-white/20';
    btn.textContent = p.name;
    btn.onclick = ()=> setCurrent(p.name);
    host.appendChild(btn);
  });
  const curr = fs.current?.name;
  if(!curr && fs.pages.length) setCurrent(fs.pages[0].name);
  highlightActiveTab();
}

function highlightActiveTab(){
  const curr = fs.current?.name;
  [...document.querySelectorAll('#tabBar button')].forEach(b=>{
    if(b.textContent===curr){ b.classList.add('bg-white/10'); }
    else{ b.classList.remove('bg-white/10'); }
  });
}

// ------------------------------
// Förhandsvisning (säker injektion)
// ------------------------------
function writePreview(route = (fs.current?.name || 'index.html')){
  const preview = $('#preview');
  if(!fs.current) return;

  const page = fs.pages.find(p=>p.name===route) || fs.current;

  // Bridge: få router-klickar från preview => byt sida i editorn.
  const bridge = `
<script>
  (function(){
    // SPA-lik navigation inom preview
    document.addEventListener('click', function(e){
      let a = e.target.closest('a[href$=".html"]');
      if(!a) return;
      const href = a.getAttribute('href');
      if(!href) return;
      e.preventDefault();
      window.parent.postMessage({type:'navigate', href:href}, '*');
    }, true);
  })();
<\/script>`;

  function wrap(html){
    // Om redan har </body> injicera före. Annars addera i slutet.
    if(html.includes('</body>')) return html.replace('</body>', bridge + '</body>');
    return html + bridge;
  }
  const blob = new Blob([wrap(page.content)], {type:'text/html'});
  const url  = URL.createObjectURL(blob);
  preview.src = url;
  preview.onload = ()=> URL.revokeObjectURL(url);
}

// meddelanden från iframe (navigate)
window.addEventListener('message', (e)=>{
  if(e.data?.type==='navigate'){
    const target = e.data.href;
    const exists = fs.pages.find(p=>p.name===target);
    if(exists) setCurrent(target);
    else addPage(target); // skapa ny tom om ej finns
  }
});

// öppna i ny flik
$('#openNew').onclick = ()=>{
  if(!fs.current) return;
  const blob = new Blob([fs.current.content], {type:'text/html'});
  const url  = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 30000);
};

// fullscreen overlay
const FS = { wrap: $('#fs_wrap'), frame: $('#fs_iframe'), btn: $('#fullscreen'), close: $('#fs_close') };
FS.btn.onclick = ()=>{
  if(!fs.current) return;
  FS.wrap.classList.add('active');
  const blob = new Blob([fs.current.content], {type:'text/html'});
  const url  = URL.createObjectURL(blob);
  FS.frame.src = url;
  FS.frame.onload = ()=> URL.revokeObjectURL(url);
};
FS.close.onclick = ()=> {
  FS.wrap.classList.remove('active');
  FS.frame.src = 'about:blank';
};

// ------------------------------
// UI-knappar
// ------------------------------
$('#addTab').onclick = ()=> addPage();
$('#formatBtn').onclick = ()=>{
  const s = $('#editor').value
    .replace(/>[ \t\r]*\n[ \t]*/g, '>\n')  // trimma whitespace efter radbryt
    .replace(/\n{3,}/g, '\n\n');          // max 2 tomrader
  $('#editor').value = s;
  if(fs.current) fs.current.content = s;
};
$('#updatePreview').onclick = ()=>{
  if(!fs.current) return;
  fs.current.content = $('#editor').value;
  writePreview(fs.current.name);
};
$('#newProject').onclick = ()=>{
  fs.pages = [{name:'index.html', content:DEFAULT_START}];
  setCurrent('index.html'); renderTabs();
};
$('#exportProject').onclick = ()=>{
  const json = JSON.stringify({files: fs.pages}, null, 2);
  const blob = new Blob([json], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'webneva-project.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 20000);
};

// Uppdatera state när man skriver
$('#editor').addEventListener('input', ()=>{
  if(fs.current) fs.current.content = $('#editor').value;
});

// ------------------------------
// AI-integration (DeepSite + ChatGPT)
// ------------------------------
async function refineBrief(raw){
  // Förfinar prompten så DeepSite förstår exakt
  const r = await fetch('/api/openai', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ type:'refine', brief: raw })
  });
  const j = await r.json();
  return j.refined || raw;
}

async function explainCode(){
  if(!fs.current) return;
  const r = await fetch('/api/openai', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ type:'explain', code: fs.current.content })
  });
  const j = await r.json();
  $('#explanations').textContent = j.reply || 'Ingen förklaring.';
}

async function improveCurrent(prompt){
  if(!fs.current) return;
  const refined = await refineBrief(prompt);
  // försök först DeepSite improve
  try{
    const r = await fetch('/api/deepsite', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ mode:'improve', prompt: refined, html: fs.current.content })
    });
    if(r.ok){
      const j = await r.json();
      const html = j?.html || j?.files?.[0]?.content;
      if(html){
        fs.current.content = html; $('#editor').value = html; writePreview(); return;
      }
    }
  }catch(e){}
  // fallback OpenAI improve
  const r2 = await fetch('/api/openai', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ type:'improve', message: refined, code: fs.current.content })
  });
  const j2 = await r2.json();
  if(j2.reply){ fs.current.content = j2.reply; $('#editor').value=j2.reply; writePreview(); }
}

async function generateSite(raw){
  const refined = await refineBrief(raw);
  const r = await fetch('/api/deepsite', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ mode:'generate', prompt: refined })
  });
  const j = await r.json();

  const isHtml = (txt)=>/<html[\s\S]*<\/html>/i.test(txt||'');

  if(j?.files?.length && isHtml(j.files[0]?.content)){
    fs.pages = j.files.map(f=>({name:f.name || 'index.html', content:f.content || ''}));
  }else if(j?.html && isHtml(j.html)){
    fs.pages = [{name:'index.html', content:j.html}];
  }else{
    // fallback - skapa själv en enkel sida
    fs.pages = [{
      name:'index.html',
      content:`<!doctype html><html lang="sv"><head><meta charset="utf-8">
      <title>Genererad sida</title><link rel="stylesheet" href="https://cdn.tailwindcss.com">
      </head><body class="bg-gray-50 flex items-center justify-center h-screen">
      <div class="text-center"><h1 class="text-3xl font-bold text-red-600 mb-4">Inget HTML-svar</h1>
      <p>DeepSite returnerade ingen kod. Prova igen med en tydligare prompt.</p></div>
      </body></html>`
    }];
  }
  setCurrent('index.html');
  renderTabs();
}

  const refined = await refineBrief(raw);
  const r = await fetch('/api/deepsite', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ mode:'generate', prompt: refined })
  });
  const j = await r.json();
  if(j?.files?.length){
    fs.pages = j.files.map(f=>({name:f.name || 'index.html', content:f.content || ''}));
  }else if(j?.html){
    fs.pages = [{name:'index.html', content:j.html}];
  }else{
    // Fallback om DeepSite inte gav resultat
    fs.pages = [{name:'index.html', content: FALLBACK_FROM_BRIEF(refined)}];
  }
  setCurrent('index.html'); renderTabs();
}

// Knappar för AI
$('#explainBtn').onclick = explainCode;
$('#improveBtn').onclick = ()=> improveCurrent('Förbättra design, layout, responsivitet och tillgänglighet.');
$('#applyImprove').onclick = ()=>{
  const m = $('#aiPrompt').value.trim();
  if(!m) return alert('Skriv vad som ska ändras.');
  improveCurrent(m);
};
$('#generateSite').onclick = ()=>{
  const m = $('#aiPrompt').value.trim();
  if(!m) return alert('Skriv vad du vill skapa.');
  generateSite(m);
};

// ------------------------------
// Init från index (query params)
// ------------------------------
function getQuery(){
  const u = new URL(location.href);
  return Object.fromEntries(u.searchParams.entries());
}
const DEFAULT_START = `<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Start</title>
<link rel="stylesheet" href="https://cdn.tailwindcss.com?plugins=forms,typography">
</head>
<body class="bg-slate-50">
<main class="max-w-5xl mx-auto p-8">
  <h1 class="text-3xl font-bold">Tomt projekt</h1>
  <p class="text-slate-600 mt-2">Ange ett mål i AI-rutan (t.ex. “Skapa en företagssida…”) och klicka Generera.</p>
</main>
</body>
</html>`;

function FALLBACK_FROM_BRIEF(brief){
  return `<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Genererad sida</title>
<link rel="stylesheet" href="https://cdn.tailwindcss.com?plugins=forms,typography">
</head>
<body class="bg-white text-slate-800">
<header class="bg-slate-900 text-white">
  <div class="max-w-6xl mx-auto px-6 py-6 flex items-center justify-between">
    <div class="text-xl font-bold">Demo</div>
    <nav class="hidden md:flex gap-6 text-sm opacity-80">
      <a href="index.html" class="hover:opacity-100">Start</a>
      <a href="kontakt.html" class="hover:opacity-100">Kontakt</a>
    </nav>
  </div>
</header>
<main class="max-w-6xl mx-auto px-6 py-10">
  <h1 class="text-4xl font-extrabold mb-4">Genererad sida</h1>
  <p class="prose max-w-prose">Skapad utifrån brief:</p>
  <pre class="bg-slate-100 p-4 rounded border border-slate-200 overflow-auto text-sm">${brief.replace(/[<>]/g, s => ({'<':'&lt;','>':'&gt;'}[s]))}</pre>
</main>
<footer class="mt-16 py-6 text-center text-sm text-slate-500 border-t">© Webneva Studio</footer>
</body>
</html>`;
}

(async function init(){
  const q = getQuery();

  // start med en enkel sida
  fs.pages = [{name:'index.html', content:DEFAULT_START}];
  setCurrent('index.html'); renderTabs();

  // auto-läge från index/quiz:
  if(q.mode==='generate' && q.prompt){
    $('#aiPrompt').value = q.prompt;
    await generateSite(q.prompt);
    return;
  }
  if(q.mode==='improve' && q.hasCode==='1' && q.code){
    const raw = decodeURIComponent(escape(atob(q.code)));
    fs.pages = [{name:'index.html', content:raw}];
    setCurrent('index.html'); renderTabs(); writePreview(); return;
  }
})();
</script>
</body>
</html>
