<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webneva Studio ‚Äî AI-driven webbutveckling</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:  "#eef6ff",
              100: "#dbeafe",
              200: "#bfdbfe",
              300: "#93c5fd",
              400: "#60a5fa",
              500: "#3b82f6",
              600: "#2563eb",
              700: "#1d4ed8",
              800: "#1e40af",
              900: "#1e3a8a",
            }
          },
          boxShadow: {
            soft: "0 10px 30px rgba(2, 8, 23, .08)",
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --panel:#0f172a;     /* v√§nster m√∂rk panel */
      --ink:#e2e8f0;
      --ink-dim:#94a3b8;
      --paper:#f8fafc;     /* ljus workspace */
    }
    html,body{height:100%}
    body{background:linear-gradient(180deg,#0b1220 0%,#0b1220 48%, #0f172a 48%, #0f172a 100%);}

    /* scrollbar lite snyggare */
    *::-webkit-scrollbar{height:10px;width:10px}
    *::-webkit-scrollbar-thumb{background:rgba(148,163,184,.4);border-radius:8px}
    *::-webkit-scrollbar-track{background:transparent}

    /* sm√• mikro-animeringar */
    .btn-press:active{transform:translateY(1px)}
    .fade-in{animation:fade .25s ease-out}
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
  </style>
</head>
<body class="min-h-full text-slate-100">

  <!-- HEADER (blandning: m√∂rk b√•rd + ljus chipar) -->
  <header class="sticky top-0 z-40 bg-[#0b1220]/60 backdrop-blur border-b border-white/10">
    <div class="max-w-screen-2xl mx-auto px-4 py-3 flex items-center gap-3">
      <img src="images/bgk-remove.webneva.png" alt="Webneva" class="h-8 w-auto select-none" />
      <div class="text-xl md:text-2xl font-extrabold tracking-tight">
        Webneva <span class="text-brand-400">Studio</span>
        <span class="align-top ml-2 text-[10px] px-2 py-1 rounded-full bg-green-500/15 text-green-400 ring-1 ring-green-500/25">LIVE</span>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button id="newProject" class="btn-press rounded-lg bg-white/5 hover:bg-white/10 px-3 py-2 text-sm ring-1 ring-white/10">Nytt projekt</button>
        <button id="exportBtn" class="btn-press rounded-lg bg-white/5 hover:bg-white/10 px-3 py-2 text-sm ring-1 ring-white/10">Exportera</button>

        <div class="relative">
          <button id="profileBtn" class="btn-press rounded-lg bg-white/5 hover:bg-white/10 px-3 py-2 text-sm ring-1 ring-white/10">Profil ‚ñæ</button>
          <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 bg-[#0f172a] ring-1 ring-white/10 rounded-xl p-2 shadow-soft">
            <a class="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm" href="#" onclick="alert('Kommer snart ‚ú®');return false;">Inst√§llningar</a>
            <a class="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm" href="#" onclick="alert('Kommer snart ‚ú®');return false;">Team</a>
            <a class="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm" href="index.html">Startida</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- LAYOUT -->
  <main class="max-w-screen-2xl mx-auto p-4 grid grid-cols-12 gap-4">
    <!-- V√ÑNSTERPANEL (m√∂rk) -->
    <aside class="col-span-12 lg:col-span-4 rounded-2xl bg-[var(--panel)] ring-1 ring-white/10 shadow-soft p-3 lg:p-4">
      <!-- Flikar / sidor -->
      <div class="mb-3">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-[var(--ink)]/90">Sidor</h3>
          <button id="addTab" class="btn-press text-xs px-2 py-1 rounded-md bg-white/5 hover:bg-white/10 ring-1 ring-white/10">+ Ny sida</button>
        </div>
        <div id="tabs" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- EDITOR -->
      <div class="space-y-2">
        <div class="flex items-center gap-2">
          <h3 class="text-sm font-semibold text-[var(--ink)]/90">HTML / CSS / JS</h3>
          <span id="dirtyBadge" class="hidden text-xs px-2 py-0.5 rounded-full bg-amber-500/15 text-amber-300 ring-1 ring-amber-500/25">osparade √§ndringar</span>
        </div>
        <textarea id="editor" spellcheck="false"
          class="h-[240px] lg:h-[420px] w-full rounded-xl p-3 text-sm font-mono bg-[#0b1220] text-slate-200 ring-1 ring-white/10 focus:outline-0 focus:ring-brand-500/40"
          placeholder="Din HTML h√§r‚Ä¶"></textarea>

        <div class="flex flex-wrap items-center gap-2">
          <button id="formatBtn" class="btn-press px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-sm">Formatera</button>
          <button id="updatePreview" class="btn-press px-3 py-2 rounded-lg bg-brand-600 hover:bg-brand-700 text-white text-sm">Uppdatera</button>

          <div class="relative group">
            <button id="aiMenuBtn" class="btn-press px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 ring-1 ring-white/10 text-sm">AI</button>
            <div id="aiMenu" class="hidden absolute mt-2 left-0 w-56 bg-[#0f172a] ring-1 ring-white/10 rounded-xl p-2 shadow-soft z-10">
              <button id="improveBtn" class="w-full text-left block px-3 py-2 rounded-lg hover:bg-white/5 text-sm">‚ú® F√∂rb√§ttra aktuell sida</button>
              <button id="explainBtn" class="w-full text-left block px-3 py-2 rounded-lg hover:bg-white/5 text-sm">üîç F√∂rklara koden</button>
            </div>
          </div>
        </div>

        <!-- PROMPT -->
        <div class="mt-3">
          <label class="text-xs font-semibold text-[var(--ink-dim)]">AI-assistent</label>
          <div class="flex gap-2 mt-1">
            <input id="aiPrompt" class="flex-1 rounded-xl bg-[#0b1220] text-slate-200 ring-1 ring-white/10 px-3 py-2 text-sm"
                   placeholder="Ex: ‚ÄùSkapa en hemsida f√∂r en restaurang. R√∂tt/svart tema. Sidor: Start, Meny, Boka bord, Kontakt.‚Äù">
            <button id="generateSite" class="btn-press px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">Generera</button>
            <button id="applyImprove" class="btn-press px-3 py-2 rounded-lg bg-brand-600 hover:bg-brand-700 text-white text-sm">F√∂rb√§ttra</button>
          </div>
          <p class="text-[10px] text-[var(--ink-dim)] mt-1">
            Tips: anger du bara en id√© skapar AI hela strukturen, navbar och undersidor automatiskt.
          </p>
        </div>

        <!-- F√ñRKLARINGAR -->
        <details class="group mt-3 rounded-xl ring-1 ring-white/10 open:ring-brand-500/30 bg-[#0b1220]">
          <summary class="cursor-pointer list-none px-3 py-2 text-sm text-[var(--ink)]/90">
            <span class="group-open:hidden">‚ñ∏ AI F√∂rklaringar</span>
            <span class="hidden group-open:inline">‚ñæ AI F√∂rklaringar</span>
          </summary>
          <div id="explanations" class="px-3 pb-3 text-sm text-slate-300/90">
            H√§r visas AIs f√∂rklaringar av din kod.
          </div>
        </details>
      </div>
    </aside>

    <!-- WORKSPACE (ljus) -->
    <section class="col-span-12 lg:col-span-8">
      <div class="rounded-2xl bg-[var(--paper)] text-slate-900 ring-1 ring-slate-200 shadow-soft overflow-hidden">
        <!-- Workspace header -->
        <div class="flex items-center justify-between px-3 md:px-4 py-2 border-b border-slate-200 bg-white">
          <div class="text-sm font-semibold text-slate-700">F√∂rhandsvisning</div>
          <div class="flex items-center gap-2">
            <button id="openNewTab" class="btn-press text-xs px-2 py-1 rounded-md ring-1 ring-slate-300 hover:bg-slate-50">√ñppna i ny flik</button>
            <button id="fullscreenBtn" class="btn-press text-xs px-2 py-1 rounded-md ring-1 ring-slate-300 hover:bg-slate-50">Full vy</button>
          </div>
        </div>

        <!-- Preview wrapper -->
        <div class="relative">
          <iframe id="preview" class="w-full h-[70vh] md:h-[78vh] bg-white block"></iframe>
          <div id="loading" class="hidden absolute inset-0 grid place-items-center bg-white/70">
            <div class="text-slate-700 text-sm flex items-center gap-2">
              <svg class="animate-spin h-5 w-5 text-brand-600" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="3" opacity=".25"/>
                <path d="M21 12a9 9 0 0 1-9 9" stroke="currentColor" stroke-width="3"/>
              </svg>
              Genererar‚Ä¶
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- =============== SCRIPTS =============== -->
  <script>
  /* ---------- helpers ---------- */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  function show(el){el.classList.remove('hidden')}
  function hide(el){el.classList.add('hidden')}

  function slug(name){
    return (name||'index').trim().toLowerCase()
      .replace(/\s+/g,'-').replace(/[^a-z0-9\-\.]/g,'') + (name.endsWith('.html')?'':'.html');
  }

  /* ---------- simple FS in memory ---------- */
  const fs = {
    pages: [],
    current: null
  };

  function setDirty(on){
    $('#dirtyBadge').classList.toggle('hidden', !on);
  }

  /* ---------- tabs ---------- */
  function drawTabs(){
    const wrap = $('#tabs');
    wrap.innerHTML = '';
    fs.pages.forEach(p=>{
      const btn = document.createElement('button');
      btn.className = 'text-xs px-2 py-1 rounded-lg ring-1 ring-white/10 hover:bg-white/10 ' +
        (fs.current && fs.current.name===p.name ? 'bg-white/10 text-white' : 'text-slate-300');
      btn.textContent = p.name;
      btn.onclick = ()=> setCurrent(p.name);
      wrap.appendChild(btn);
    });
  }

  function addPage(name='ny-sida.html', content='<!DOCTYPE html>\n<html lang="sv">\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1">\n<title>Ny sida</title>\n<link rel="preconnect" href="https://fonts.googleapis.com">\n<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">\n</head>\n<body class="bg-gray-50 text-gray-900">\n<nav class="p-4 bg-white shadow"><a href="index.html" class="text-blue-600 hover:underline">Start</a></nav>\n<main class="max-w-4xl mx-auto p-8"><h1 class="text-3xl font-bold">Ny sida</h1><p class="mt-2 text-gray-600">Inneh√•ll h√§r‚Ä¶</p></main>\n</body>\n</html>\n'){
    const n = slug(name);
    fs.pages.push({ name:n, content });
    setCurrent(n);
    drawTabs();
  }

  function setCurrent(name){
    fs.current = fs.pages.find(p=>p.name===name);
    if(!fs.current){ return; }
    $('#editor').value = fs.current.content;
    writePreview(name);
    drawTabs();
    setDirty(false);
  }

  /* ---------- iframe preview + bridge ---------- */
  function bridgeJS(){
    // enkel client-router i preview (f√•ngar interna l√§nkar)
    return `
<script>
(function(){
  document.addEventListener('click', function(e){
    const a = e.target.closest('a[href]');
    if(!a) return;
    const href = a.getAttribute('href');
    if(href && !href.startsWith('http') && !href.startsWith('#')){
      e.preventDefault();
      parent.postMessage({type:'navigate', href:href}, '*');
    }
  }, true);
})();
<\/script>`;
  }

  function writePreview(routeName){
    const preview = $('#preview');
    const page = routeName ? fs.pages.find(p=>p.name===routeName) : fs.current;
    if(!page) return;

    // injicera bridge i body
    const html = page.content;
    const final = html.includes('</body>') ? html.replace('</body>', bridgeJS() + '</body>') : (html + bridgeJS());

    const blob = new Blob([final], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    preview.src = url;
    preview.onload = ()=> URL.revokeObjectURL(url);
  }

  // navigering fr√•n preview
  window.addEventListener('message', (e)=>{
    if(e.data?.type==='navigate'){
      const target = slug(e.data.href);
      const exists = fs.pages.find(p=>p.name===target);
      if(exists){ setCurrent(target); }
      else {
        // Skapa placeholdersida f√∂r att upplevelsen ska k√§nnas "riktig"
        addPage(target, `
<!doctype html><html lang="sv"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.tailwindcss.com?plugins=forms,typography">
<body class="bg-gray-50">
<nav class="p-4 bg-white shadow">
  <a class="text-blue-600 hover:underline" href="index.html">‚Üê Tillbaka</a>
</nav>
<main class="max-w-4xl mx-auto p-8">
  <h1 class="text-2xl font-bold">${target.replace('.html','')}</h1>
  <p class="text-gray-600 mt-2">Tom sida ‚Äî fyll p√• med inneh√•ll.</p>
</main>
</body></html>`);
      }
    }
  });

  /* ---------- formatting ---------- */
  function prettyCompact(s){
    // liten, s√§ker formattering utan att f√∂rst√∂ra script/css
    return s
      .replace(/[ \t]+$/gm,'')
      .replace(/\n{3,}/g,'\n\n')
      .replace(/>\s+\n</g, '>\n<');
  }

  /* ---------- AI calls ---------- */
  async function explainCode(){
    if(!fs.current) return;
    const r = await fetch('/api/openai',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type:'explain', code: $('#editor').value })
    });
    const data = await r.json().catch(()=>({}));
    $('#explanations').textContent = data.reply || 'Kunde inte f√• svar.';
  }

  async function improveCurrent(message){
    if(!fs.current) return;
    try{
      const r = await fetch('/api/deepsite',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ mode:'improve', prompt: message, html: $('#editor').value })
      });
      if(r.ok){
        const d = await r.json();
        const html = d?.html || d?.files?.[0]?.content;
        if(html){
          $('#editor').value = html;
          fs.current.content = html;
          writePreview();
          setDirty(false);
          return;
        }
      }
    }catch(_e){/* noop */ }

    // fallback: OpenAI
    const r2 = await fetch('/api/openai',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type:'improve', message, code: $('#editor').value })
    });
    const d2 = await r2.json().catch(()=>({}));
    if(d2.reply){
      $('#editor').value = d2.reply;
      fs.current.content = d2.reply;
      writePreview();
      setDirty(false);
    }
  }

  async function generateSite(prompt, settings={}){
    show($('#loading'));
    try{
      const r = await fetch('/api/deepsite',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ mode:'generate', prompt, settings })
      });
      const data = await r.json().catch(()=>({}));
      if(data?.files?.length){
        fs.pages = data.files.map(f=>({ name: slug(f.name||'index.html'), content: f.content||'' }));
      } else if(data?.html){
        fs.pages = [{ name:'index.html', content:data.html }];
      } else {
        // Minimal fallback
        fs.pages = [{
          name:'index.html',
          content:`<!doctype html>
<html lang="sv"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.tailwindcss.com?plugins=forms,typography" rel="preload" as="style">
<body class="bg-gray-50 text-gray-900">
<nav class="p-4 bg-white shadow"><a href="index.html" class="text-blue-600">Start</a></nav>
<main class="max-w-4xl mx-auto p-8">
  <h1 class="text-3xl font-bold">Genererad sida</h1>
  <p class="mt-3 text-gray-600">${prompt}</p>
</main></body></html>`
        }];
      }
      setCurrent('index.html');
    } finally {
      hide($('#loading'));
    }
  }

  /* ---------- buttons & UI ---------- */
  // Profilmeny
  $('#profileBtn').addEventListener('click', ()=>{
    $('#profileMenu').classList.toggle('hidden');
  });
  document.addEventListener('click',(e)=>{
    if(!e.target.closest('#profileBtn') && !e.target.closest('#profileMenu')){
      $('#profileMenu').classList.add('hidden');
    }
  });

  // AI-menyn
  $('#aiMenuBtn').addEventListener('click', ()=>{
    $('#aiMenu').classList.toggle('hidden');
  });
  document.addEventListener('click',(e)=>{
    if(!e.target.closest('#aiMenuBtn') && !e.target.closest('#aiMenu')){
      $('#aiMenu').classList.add('hidden');
    }
  });

  $('#formatBtn').onclick = ()=>{
    const s = prettyCompact($('#editor').value);
    $('#editor').value = s;
    if(fs.current){ fs.current.content = s; setDirty(true); }
  };

  $('#updatePreview').onclick = ()=>{
    if(!fs.current) return;
    fs.current.content = $('#editor').value;
    writePreview(fs.current.name);
    setDirty(false);
  };

  $('#improveBtn').onclick = ()=> improveCurrent('F√∂rb√§ttra design, layout och tillg√§nglighet.');
  $('#explainBtn').onclick = explainCode;

  $('#applyImprove').onclick = ()=>{
    const m = $('#aiPrompt').value.trim();
    if(!m) return alert('Skriv vad som ska √§ndras.');
    improveCurrent(m);
  };

  $('#generateSite').onclick = ()=>{
    const p = $('#aiPrompt').value.trim();
    if(!p) return alert('Skriv vad du vill skapa.');
    generateSite(p, {/* ev. f√§rger/sidor skickas med fr√•n index via query √§nd√• */});
  };

  $('#addTab').onclick = ()=> addPage();

  $('#openNewTab').onclick = ()=>{
    // √∂ppna aktuell sida som statisk f√∂rhandsvisning
    const page = fs.current || fs.pages[0];
    if(!page) return;
    const final = page.content.includes('</body>') ? page.content.replace('</body>','</body>') : page.content;
    const blob = new Blob([final],{type:'text/html'});
    const url = URL.createObjectURL(blob);
    window.open(url,'_blank','noopener,noreferrer');
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  };

  // Fullscreen preview
  let fsOn = false;
  $('#fullscreenBtn').onclick = ()=>{
    fsOn = !fsOn;
    $('#fullscreenBtn').textContent = fsOn ? 'Avsluta full vy' : 'Full vy';
    const iframe = $('#preview');
    if(fsOn){
      iframe.classList.remove('h-[70vh]','md:h-[78vh]');
      iframe.style.height = 'calc(100vh - 140px)';
      document.documentElement.scrollTo({top:0, behavior:'smooth'});
    } else {
      iframe.style.height = '';
      iframe.classList.add('h-[70vh]','md:h-[78vh]');
    }
  };

  $('#newProject').onclick = ()=>{
    fs.pages = [{
      name:'index.html',
      content:`<!doctype html><html lang="sv"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.tailwindcss.com?plugins=forms,typography" rel="preload" as="style">
<body class="bg-gray-50">
<nav class="p-4 bg-white shadow"><a class="text-blue-600" href="index.html">Start</a></nav>
<main class="max-w-4xl mx-auto p-8">
  <h1 class="text-2xl font-bold">Nytt projekt</h1>
  <p class="text-gray-600 mt-2">Startklar.</p>
</main></body></html>`
    }];
    setCurrent('index.html');
  };

  $('#exportBtn').onclick = ()=>{
    const archive = {
      files: fs.pages.reduce((acc,p)=> (acc[p.name]=p.content, acc), {})
    };
    const blob = new Blob([JSON.stringify(archive,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='webneva-project.json';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 3000);
  };

  // √§ndringar i editor
  $('#editor').addEventListener('input', ()=>{
    if(fs.current) { fs.current.content = $('#editor').value; setDirty(true); }
  });

  /* ---------- init (fr√•n quiz p√• index) ---------- */
  function getQuery(){
    const u = new URL(location.href);
    return Object.fromEntries(u.searchParams.entries());
  }

  (async function init(){
    // default tomt
    fs.pages = [{
      name:'index.html',
      content:`<!doctype html><html lang="sv"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.tailwindcss.com?plugins=forms,typography" rel="preload" as="style">
<body class="bg-gray-50 text-gray-900">
<nav class="p-4 bg-white shadow"><a class="text-blue-600 hover:underline" href="index.html">Start</a></nav>
<main class="max-w-4xl mx-auto p-8">
  <h1 class="text-3xl font-bold">Tomt projekt</h1>
  <p class="mt-2 text-gray-600">Skriv vad du vill bygga i f√§ltet till v√§nster och klicka <em>Generera</em>, eller klistra in din kod och klicka <em>Uppdatera</em>.</p>
</main></body></html>`
    }];
    setCurrent('index.html');
    drawTabs();

    const q = getQuery();
    if(q.prompt) $('#aiPrompt').value = q.prompt;

    // improve-fl√∂de med inklistrad kod
    if(q.mode==='improve' && q.hasCode==='1' && q.code){
      try{
        const raw = decodeURIComponent(escape(atob(q.code)));
        fs.pages = [{name:'index.html', content:raw}];
        setCurrent('index.html');
        writePreview();
      }catch(_e){}
      return;
    }
    // generate-fl√∂de
    if(q.mode==='generate' && q.prompt){
      await generateSite(q.prompt, { colors:q.colors||'', pages:q.pages||'' });
      return;
    }
  })();
  </script>
</body>
</html>
