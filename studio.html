<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Webneva Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0b1120; color: #e5e7eb; font-family: Inter, sans-serif; margin:0; overflow:hidden; }
    .btn { border: 1px solid rgba(255,255,255,.1); border-radius: 8px; padding: .5rem .9rem; font-weight: 600; }
    .btn:hover { background: rgba(255,255,255,.05); }
    .btn-primary { background: #3b82f6; border-color: #3b82f6; color: white; }
    .thinking { height:4px; background:linear-gradient(90deg,transparent,rgba(59,130,246,.3),transparent);
                background-size:200% 100%; animation:shimmer 1.5s linear infinite;}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
  </style>
</head>
<body>
  <header class="flex justify-between items-center px-4 h-12 border-b border-white/10">
    <div class="font-bold">Webneva Studio</div>
    <button id="newBtn" class="btn">Nytt projekt</button>
  </header>

  <main class="grid grid-cols-[25%_75%] h-[calc(100vh-3rem)]">
    <section class="flex flex-col border-r border-white/10">
      <div id="info" class="p-4 text-sm text-slate-400"></div>
      <div class="p-3 border-t border-white/10">
        <textarea id="prompt" class="w-full h-24 bg-[#0f172a] border border-white/10 rounded-lg p-2 text-sm" placeholder="Förbättra designen..."></textarea>
        <button id="sendBtn" class="btn-primary mt-2 w-full">Skicka</button>
      </div>
    </section>
    <section class="relative">
      <iframe id="preview" class="absolute inset-0 w-full h-full border-0 bg-white"></iframe>
      <div id="loading" class="hidden absolute top-0 left-0 right-0 thinking"></div>
    </section>
  </main>

  <script type="module">
    import { aiGenerate, aiImprove } from "./js/ai.js";
    const setup = JSON.parse(localStorage.getItem("WEBNEVA_SETUP_V1") || "{}");
    const info = document.getElementById("info");
    const loading = document.getElementById("loading");
    const frame = document.getElementById("preview");
    const promptEl = document.getElementById("prompt");

    info.innerHTML = Object.entries(setup.answers || {})
      .map(([k,v]) => `<div><b>${k}</b>: ${Array.isArray(v)?v.join(", "):v}</div>`)
      .join("");

    function setLoading(on){ loading.classList.toggle("hidden",!on); }

    async function runInitial(){
      setLoading(true);
      try {
        const p = `Skapa en komplett HTML-webbplats för ${setup.answers.topic || "ett företag"}.
Den ska innehålla sidorna ${setup.answers.pages?.join(", ") || "Startsida"}.
Stilen ska vara ${setup.answers.style || "modern & minimalistisk"}.
Använd TailwindCSS och skapa en snygg hero, tjänstesektion och kontakt.`;
        const html = await aiGenerate(p);
        updatePreview(html);
      } catch(err){ console.error(err); alert("Fel vid AI-generering"); }
      finally{ setLoading(false); }
    }

    function updatePreview(html){
      const blob=new Blob([html],{type:"text/html"});
      frame.src=URL.createObjectURL(blob);
    }

    async function send(){
      const p=promptEl.value.trim(); if(!p) return;
      setLoading(true);
      try {
        const html = await aiImprove(p, "");
        updatePreview(html);
      } catch(err){ alert("Fel vid förbättring"); }
      finally{ setLoading(false); }
    }

    document.getElementById("sendBtn").onclick=send;
    document.getElementById("newBtn").onclick=()=>{localStorage.removeItem("WEBNEVA_SETUP_V1");location.href="index.html";};
    if(setup.autoRun) runInitial();
  </script>
</body>
</html>
